<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8" />
<title>Web of Things (WoT) Discovery</title>
<script 
    src="https://www.w3.org/Tools/respec/respec-w3c"
    class="remove"
    defer
></script>
<script class="remove">
        var respecConfig = {
        lint: {
            "check-punctuation": true,
            "local-refs-exist": true,
            "no-http-props": true,
            "no-headingless-sections": true
        },
        doJsonLd : true,
        specStatus : "ED",
        shortName : "wot-discovery",
        copyrightStart : 2017,
        group: "wg/wot",
        wgPublicList : "public-wot-wg",
        github: {
            repoURL: "https://github.com/w3c/wot-discovery",
            branch: "master"
        },
        previousPublishDate: "2020-11-24",
        previousMaturity: "FPWD",
        editors : [ {
            name : "Andrea Cimmino",
            w3cid : "115672",
            company : "Universidad Politécnica de Madrid",
            companyURL : "https://www.upm.es/"
        }, {
            name : "Michael McCool",
            w3cid : "93137",
            company : "Intel Corp.",
            companyURL : "https://www.intel.com/"
        }, {
            name : "Farshid Tavakolizadeh",
            w3cid : "122520",
            company : "Fraunhofer-Gesellschaft",
            companyURL : "https://www.fraunhofer.de/"
        }, {
            name : "Kunihiko Toumura",
            w3cid : "83488",
            company : "Hitachi, Ltd.",
            companyURL : "https://www.hitachi.com/"
        } ],
        otherLinks : [
                {
                    key : "Contributors",
                    data : [ {
                        value : "In the GitHub repository",
                        href : "https://github.com/w3c/wot-discovery/graphs/contributors"
                    } ]
                }],
        localBiblio : {
            "REST-IOT" : {
                  title: "RESTful Design for Internet of Things Systems"
                , href: "https://tools.ietf.org/html/draft-irtf-t2trg-rest-iot-06"
                , authors:  [
                    "Ari Keranen"
                  , "Matthias Kovatsch"
                  , "Klaus Hartke"
                  ]
                , publisher: "IETF"
                , date: "11 May 2020"
            },
            "CoRE-RD" : {
                  title: "CoRE Resource Directory"
                , href: "https://tools.ietf.org/html/draft-ietf-core-resource-directory-26"
                , authors: [
                    "Christian Amsüss"
                  , "Zach Shelby"
                  , "Michael Koster"
                  , "Carsten Bormann"
                  , "Peter van der Stok"
                  ]
                , publisher: "IETF"
                , date: "2 November 2020"
            },
            "JSONPATH" : {
                  title: "JavaScript Object Notation (JSON) Path"
                , href: "https://datatracker.ietf.org/doc/html/draft-ietf-jsonpath-base-00"
                , authors: [
                    "Glyn Normington"
                  , "Edward Surov"
                  , "Marko Mikulicic"
                  , "Stefan Gössner"
                  ]
                , publisher: "IETF"
                , date: "7 March 2021"
                , status: "DRAFT",
            },
            "wot-usecases" : {
                  title: "Web of Things (WoT): Use Cases"
                , href: "https://w3c.github.io/wot-usecases/"
                , authors: [
                    "Michael Lagally"
                  , "Michael McCool"
                  , "Ryuichi Matsukura"
                  , "Tomoaki Mizushima"
                  ]
                , publisher: "W3C"
                , date: "15 October 2020"
                , status: "Editor's Draft",
            }
        }
    };
</script>
<style type="text/css">
a[href].internalDFN {
        color: inherit;
        border-bottom: 1px solid #99c;
        text-decoration: none;
}
img.wot-diagram {
    max-width: 90%;
    height: auto;
}
.rfc2119-assertion {
  background-color: rgb(230,230,230)
}
</style>
</head>
<body>
    <section id="abstract">
        <p>The W3C Web of Things (WoT) is intended to enable
           interoperability across IoT platforms and application
           domains.  One key mechanism for accomplishing this goal
           is the definition and use of metadata describing the
           interactions an IoT device or service makes available
           over the network at a suitable level of abstraction.  
           The WoT Thing Description specification satisfies this objective.
        </p>
        <p>However, in order to use a Thing its Thing Description
           first has to be obtained.  The <em>WoT Discovery</em> process described 
           in this document addresses this problem.
           WoT Discovery needs to support the distribution of WoT Thing Descriptions
           in a variety of use cases.  This includes ad-hoc and engineered systems;
           during development and at runtime; and on both local and global networks.
           The process also needs to work with existing discovery mechanisms,
           be secure, protect private information, and be able to efficiently
           handle updates to WoT Thing Descriptions and the 
           dynamic and diverse nature of the IoT ecosystem.
        </p>
        <p>The WoT Discovery process is divided into two phases,
           Introduction, and Exploration.  The Introduction phase 
           leverages existing discovery mechanisms but does not directly
           expose metadata; they are simply used to discover Exploration
           services, which provide metadata but only after secure authentication
           and authorization.  This document normatively defines two Exploration
           services, one for WoT Thing self-description with a single 
           WoT Thing Description and a searchable WoT Thing Description Directory
           service for collections of Thing Descriptions.
           A variety of Introduction services are also described and where
           necessary normative definitions are given to support them.
        </p>
    </section>
    <!-- The following will be filled in by ReSpec -->
    <section id="sotd"></section>
    <section id="introduction">
        <h1>Introduction</h1>
        <p>The Web of Things (WoT) defines an architecture that supports the integration
           and use of web technologies with IoT devices.
           The WoT Architecture [[wot-architecture]] document defines the basic
           concepts and patterns of usage supported.
           However, the WoT Thing Description [[wot-thing-description]] is a key
           specification for WoT Discovery since it is the purpose of WoT Discovery
           to make WoT Thing Descriptions available.
           Specifically, WoT Discovery has to allow authenticated and authorized entities
           (and only those entities) to find WoT Thing Descriptions satisfying a set of
           criteria, such as being near a certain location, or having certain semantics,
           or containing certain interactions.  Conversely, in order to support
           security and privacy objectives, the WoT Discovery process must not
           leak information to unauthorized entities.  This includes leaking information
           that a given entity is requesting certain information, not just the information
           distributed in the Thing Descriptions themselves.
	    </p>
        <p>There are already a number of discovery mechanisms defined, so we have to 
           establish why we are proposing a new one.  First, many existing 
           discovery mechanisms have relatively weak security and privacy protections.
           One of our objectives is to establish a mechanism that not only uses best
           practices to protect metadata, but that can be upgraded to support future
           best practices as needed.
           Second, we are using discovery in a broad sense to include both local and
           non-local mechanisms.  While a local mechanism might use a broadcast protocol,
           non-local mechanisms might go beyond the current network segment where broadcast
           is not scalable, and so a different approach, such as a search service, is needed. 
           Our approach is to use existing mechanisms as needed to bootstrap into a more 
           general and secure metadata distribution system.
           Third, the metadata we are distributing, the WoT Thing Description, is highly
           structured and includes rich data such as data schemas and semantic annotations.
           Existing discovery mechanisms based on a list of simple key-value pairs are 
           not appropriate.  
           At the same time, 
           use of existing standards for semantic data query, 
           such as SPARQL [[SPARQL11-OVERVIEW]], 
           while potentially suitable for some advanced use cases, 
           might require too much effort for many anticipated IoT applications.
           Therefore in order to address more basic applications,
           we also define some simpler query mechanisms. 
        </p>
        <p>After defining some basic terminology, we will summarize the basic use cases and
           requirements for WoT Discovery.  These are a subset of the more detailed and
           exhaustive use cases and requirements presented in the WoT Use Cases [[wot-usecases]] and 
           WoT Architecture [[wot-architecture]] documents.
           Then we will describe the basic architecture of the WoT Discovery process,
           which uses a two-phase Introduction/Exploration approach.  The basic goal of this
           architecture is to be able to use existing discovery standards to bootstrap
           access to protected discovery services, but to distribute detailed metadata only to 
           authorized users, and to also protect those making queries from eavesdroppers 
           as much as possible.
           We then describe details of specific Introduction and Exploration mechanisms.
           In particular, we define in detail a normative API for a 
           WoT Thing Description Directory (WoT TDD) service that provides a search mechanism for
           collections of WoT Thing Descriptions that can be dynamically registered by Things or
           entities acting on their behalf.  The WoT Discovery mechanism however also supports
           self-description by individual Things and one issue we address is how to distinguish
           between these two approaches.
           Finally, we discuss some security and privacy considerations, including a set of 
           potential risks and mitigations.
        </p>
    </section>
    <!-- The following will be filled in by ReSpec -->
    <section id="conformance"></section>
    <section id="terminology" class="informative">
        <h1>Terminology</h1>

        <p>
            The fundamental WoT terminology such as
            <dfn>Thing</dfn>,
            <dfn>Thing Description</dfn> (<dfn>TD</dfn>),
            <dfn>Property</dfn>,
            <dfn>Action</dfn>,
            <dfn>Event</dfn>
            are defined in <a href="https://www.w3.org/TR/wot-architecture/#terminology">Section 3</a>
            of the WoT Architecture specification [[?WOT-ARCHITECTURE]].
        </p>
        
        <p>
            In addition, this specification introduces the following definitions:
        </p>
        
        <dl>
            <dt><dfn data-lt="WoT Anonymous Thing Description">Anonymous TD</dfn>
            </dt>
            <dd>A Thing Description without a user-defined identifier (`id` attribute).
            </dd>
            <dt><dfn data-lt="WoT Discoverer">Discoverer</dfn>
            </dt>
            <dd>An entity that generates and registers a TD with an exploration service
            on behalf of a <a>Thing</a> which may not be able to do it for itself.
            </dd>
            <dt><dfn data-lt="WoT Discovery">Discovery</dfn>
            </dt>
            <dd>In the WoT context, the process of finding and retrieving Thing metadata
            in the form of Thing Descriptions for Things satisfying some criteria of interest.
            </dd>
            <dt><dfn data-lt="WoT Enriched Thing Description">Enriched TD</dfn>
            </dt>
            <dd>A Thing Description embedded with additional attributes for bookkeeping and discovery. 
            </dd>
            <dt><dfn data-lt="WoT Exploration">Exploration</dfn>
            </dt>
            <dd>A discovery mechanism that provides access to detailed metadata in the 
            form of one or more Thing Descriptions.  Exploration mechanisms are in
            general protected by security mechanism and are accessible only to authorized users.
            </dd>
            <dt><dfn data-lt="WoT Introduction">Introduction</dfn>
            </dt>
            <dd>A "first contact" discovery mechanism, whose result is a URL that
            references an exploration mechanism.  Introduction mechanisms themselves
            should not directly provide metadata, and in general are designed to be 
            open.
            </dd>
            <dt><dfn data-lt="WoT TDD">TDD</dfn>
            </dt>
            <dd>Short for Thing Description Directory.
            </dd>
            <dt><dfn data-lt="WoT Thing Description Directory">Thing Description Directory</dfn>
            </dt>
            <dd>A directory service with a prescribed API that allows the 
            registration, management, and search of a database of Thing Descriptions.
            Note that the acronym should be TDD, not TD, to avoid confusion with Thing Descriptions (TDs).
            </dd>
            <dt><dfn data-lt="WoT Partial Thing Description">Partial TD</dfn>
            </dt>
            <dd>A data model partially conformant to the Thing Description schema by including 
            only a subset of the attributes.
            </dd>
        </dl>
    </section>
    <section id="architecture" class="informative">
        <h1>Architecture</h1>
        <a href="#discovery-overview"></a> shows an overview of discovery process.
        <figure id="discovery-overview">
            <img src="images/overview.png"
                srcset="images/overview.svg"
                class="wot-diagram"
                alt="Discovery process overview" />
            <figcaption>Discovery process overview</figcaption>
        </figure>
        <p class="ednote" title="Discovery Architecture Overview">
        To do: an overview of the two-phase approach and its purpose, which is to support
        controlled and authenticated access to metadata by authorized users only.
        </p>
    </section>
    <section id="introduction-mech" class="normative">
        <h1>Introduction Mechanisms</h1>
        <p>This chapter describes mechanisms for initial contact with
           Things or <a>Thing Description Directories</a>.
           Any of the following mechanisms may 
           be provided by the Thing or the <a>Thing Description Directory</a> to Consumers.
           The result of an introduction mechanism is always a URL (address) of an exploration service
           which can be used to obtain detailed metadata (TDs) after suitable authentication.
           It is also possible for multiple introduction mechanisms to be used and the results merged.
           No particular introduction mechanism is mandatory, as long as the URL of at least one
           exploration service is somehow obtained.
        </p>

        <section id="introduction-direct" class="normative">
            <h2>Direct</h2>
            <p><span class="rfc2119-assertion" id="introduction-direct-url">To obtain an URL of an exploration service, any mechanism that results in a single URL MAY be used.</span>
               This includes Bluetooth beacons, QR codes, and written URLs to be 
               typed by a user.
                <span class="rfc2119-assertion" id="introduction-direct-thing-description">
                    A request on all such URLs MUST result in a TD as prescribed in
                    [[[#exploration-self]]].
                </span>
                For self-describing Things, this can be the TD of the Thing itself.
                <span class="rfc2119-assertion" id="introduction-direct-directory-description">
                   If the URL references a <a>Thing Description Directory</a>, this MUST be the Directory Description of the
                    <a>Thing Description Directory</a>.
                </span>
            </p>
        </section>
        <section id="introduction-well-known" class="normative">
            <h2>Well-Known URIs</h2>
            <p>
                <span class="rfc2119-assertion" id="introduction-well-known-uri">A Thing or <a>Thing Description Directory</a> MAY use the Well-Known Uniform Resource Identifier [[RFC8615]]
                to advertise its presence.</span>
                <span class="rfc2119-assertion" id="introduction-well-known-path">If the Thing or <a>Thing Description Directory</a> use the Well-Known Uniform Resource Identifier to advertise its presense, it MUST register its own Thing or Directory Description
                into the following path:
                <code>/.well-known/wot-thing-description</code>.</span>
            <p>
                <span class="rfc2119-assertion" id="introduction-well-known-thing-description">
                    When a request is made at the above Well-Known URI, the server MUST return
                    a Thing Description as prescribed in [[[#exploration-self]]].
                </span>
            </p>
            <p class="ednote" title="Registration of Well-known URI">
                The service name in Well-Known URI (<code>wot-thing-description</code>) is tentative.
                "Well-Known URIs" registry and contents of registration request is described in Section 3.1 of [[RFC8615]].
            </p>

        </section>
        <section id="introduction-dns-sd" class="normative">
            <h2>DNS-Based Service Discovery</h2>
            <p><span class="rfc2119-assertion" id="introduction-dns-sd">A Thing or <a>Thing Description Directory</a> MAY use the DNS-Based Service Discovery (DNS-SD)[[RFC6763]].</span>
                This can be also be used to discover them on the same link by combining Multicast DNS (mDNS)[[RFC6762]].
            </p>
            <p>
                In DNS-SD, format of the Service Instance Name is <code>Instance.Service.Domain</code>. 
                The Service part is a pair of labels following the conventions of [[RFC2782]].
                The first label has an underscore followed by the Service Name,
                and the second label describes the protocol.
            </p>
            <p>
                <span class="rfc2119-assertion" id="introduction-dns-sd-service-name">
                    The Service Name to indicate the Thing or <a>Thing Description Directory</a> MUST be <code>_wot</code>.
                </span>
                <span class="rfc2119-assertion" id="introduction-dns-sd-service-name-directory">
                    And the Service Name to indicate the <a>Thing Description Directory</a> MUST be <code>_directory._sub._wot</code>.
                </span>
            </p>
            <p class="ednote" title="Service Names in existing implementations">
                The Service Names <code>_wot</code> and <code>_directory._sub._wot</code>
                are tentative. The following Service Names are used in the existing implementations:
                <code>_wot</code>,
                <code>_device._sub._wot</code>,
                <code>_directory._sub._wot</code>,
                <code>_webthing</code>,
                <code>_wot-servient</code>.
                To use a Service Name, registration to "Underscored and Globally Scoped DNS Node Names"
                Registry [[RFC8552]] is required.
            </p>
            <p>
                <span class="rfc2119-assertion" id="introduction-dns-sd-txt-record">
                    In addition, the following information MUST be included in the <code>TXT</code>
                    record that is pointed to by the Service Instance Name:
                    <dl>
                        <dt><code>td</code></dt>
                        <dd>Absolute pathname of the Thing Description of the Thing or Directory Description of the <a>Thing Description Directory</a>.</dd>
                        <dt><code>type</code></dt>
                        <dd>Type of the Thing Description, i.e. <code>Thing</code> or <code>Directory</code>.
                        If omitted, the type is assumed to be <code>Thing</code>.</dd>
                    </dl>
                </span>
            </p>
            <p class="ednote" title="Usage of a TXT record in existing implementations">
                The following key/value pairs are used in the existing implementations:<br/>
                <code>retrieve</code>:
                        Absolute path name of the API to get an array of Thing Description IDs
                        from the directory service.<br/>
                <code>register</code>:
                    Absolute path name of the API to register a Directory Description with the <a>Thing Description Directory</a>.<br/>
                <code>path</code>:
                    The URI of the thing description on the Web Thing's web server<br/>
                <code>td</code>:
                    Prefix of directory service API<br/>
                <code>tls</code>:
                    Value of 1 if the Web Thing supports connections via HTTPS.<br/>
            </p>
            <p>
                <a href="#sequence-dnssd-thing"></a> and <a href="#sequence-dnssd-directory"></a> shows example sequences
                of discovery of Thing and <a>Thing Description Directory</a> using DNS-SD and mDNS. 
            </p>
            <figure id="sequence-dnssd-thing">
                <img src="images/sequence-dnssd-thing.png"
                    srcset="images/sequence-dnssd-thing.svg"
                    class="wot-diagram"
                    alt="An example sequence of discovery of Thing using DNS-SD and mDNS" />
                <figcaption>An example sequence of discovery of Thing using DNS-SD and mDNS</figcaption>
            </figure>
            <figure id="sequence-dnssd-directory">
                <img src="images/sequence-dnssd-directory.png"
                    srcset="images/sequence-dnssd-directory.svg"
                    class="wot-diagram"
                    alt="An example sequence of discovery of directory service using DNS-SD and mDNS" />
                <figcaption>An example sequence of discovery of <a>Thing Description Directory</a> using DNS-SD and mDNS</figcaption>
            </figure>

        </section>
        <section id="introduction-core-rd" class="normative">
            <h2>CoRE Link Format and CoRE Resource Directory</h2>
            <p>
                <span class="rfc2119-assertion" id="introduction-core-rd">A Thing or <a>Thing Description Directory</a> MAY advertise its presence using the
                Constrained RESTful Environment (CoRE) Link Format [[RFC6690]].</span>
                <span class="rfc2119-assertion" id="introduction-core-rd-directory">
                A Thing or <a>Thing Description Directory</a> MAY use the CoRE Resource Directory [[CoRE-RD]]
                to register a link to the Thing or Directory Description.</span>
            </p>
            <p>
                <span class="rfc2119-assertion" id="introduction-core-rd-resource-type-thing">
                    The resource type (<code>rt</code>) of the Link that targets the Thing Description of the Thing
                    MUST be <code>wot.thing</code>. 
                </span>
                <span class="rfc2119-assertion" id="introduction-core-rd-resource-type-directory">
                    The resource type of the Link that targets the Directory Description of the <a>Thing Description Directory</a>
                    MUST be <code>wot.directory</code>.
                </span>
            </p>
            <p class="ednote">
                The resource types <code>wot.thing</code> and <code>wot.directory</code> are tentative.
                See also <a href="#iana-considerations"></a>.
            </p>
        </section>
        <section id="introduction-did" class="normative">
            <h2>DID Documents</h2>
            <p><span class="rfc2119-assertion" id="introduction-did">A Thing or <a>Thing Description Directory</a> MAY advertise its presence using 
                the Decentralized Identifier (DID) [[DID-CORE]].</span>
            </p>
            <p>
                <span class="rfc2119-assertion" id="introduction-did-service-endpoint">
                    The DID Document obtained by resolving the DID of a Thing or <a>Thing Description Directory</a> MUST
                    contains a Service Endpoint which point to Thing Description of the Thing or Directory Description of the <a>Thing Description Directory</a>.
                </span>
            </p>
            <aside class="example" title="A Example Service Endpoint in a DID Document">
                <pre>
                    {
                        "service": [{
                            "id": "did:example:wotdiscoveryexample#td",
                            "type": "WotThingDescription",
                            "serviceEndpoint":
                                "https://wot.example.com/.well-known/wot-thing-description"
                        }]
                    }
                </pre>
            </aside>
            <div class="issue" data-number="65"></div>
        </section>
    </section>
    <section id="exploration-mech" class="normative">
        <h1>Exploration Mechanisms</h1>
        <p class="ednote" title="Exploration Mechanism Overview">
        To do: Description of supported explorations, and requirements for 
        new exploration mechanisms.
        </p>

        <figure id="exploration-class-diagram">
            <img src="images/exploration-class-diagram.svg"
                class="wot-diagram"
                alt="Exploration mechanisms high-level class diagram" />
            <figcaption>
                The high-level class diagram of the exploration mechanisms,
                depicting how Things expose <a>TDs</a>.
            </figcaption>
        </figure>

        [[[#exploration-class-diagram]]] depicts the high-level information 
        model for self-describing and directory services.
        A directory may contain <a>TDs</a> and at the same time provide a <a>TD</a>
        and act as a self-describing Thing.
        The exploration mechanisms are described in
        [[[#exploration-self]]] and [[[#exploration-directory]]].
        
        <figure id="discovery-class-diagram-ontology">
            <img src="images/discovery-class-diagram-ontology.svg"
                class="wot-diagram"
                alt="Ontology of TD in discovery context" />
            <figcaption>The ontology of Thing Descriptions in the Discovery context.</figcaption>
        </figure>

        <p>
            [[[#discovery-class-diagram-ontology]]] illustrates the Discovery ontology
            as an extension of the Thing ontology.
        </p>
        <p>
            The ontology includes a class for metadata that are associated with
            TDs stored in a directory.
            This class is called `RegistrationInformation` and described as part
            of the directory specification in [[[#exploration-directory-registration-info]]].
        </p>

        <p>
	        Moreover, the Discovery ontology defines two new Thing Description classes
            that may be used to model special exploratory metadata:
        </p>

        <div class="issue" data-number="148">
            The type URIs used below are tentative and subject to change.
        </div>  

        <dt>Thing Directory</dt>
        <dd>
            <span class="rfc2119-assertion" id="exploration-directory-description-type"> 
                A TD which describes a Thing Description Directory instance MUST use type `ThingDirectory` from the
                discovery context or URI `https://www.w3.org/2021/wot/discovery#ThingDirectory`.
            </span>
            <p>
                [[[#directory-thing-description]]] which describes the API of the
                Thing Description Directory is an example of this TD class.
            </p>
        </dd>
        
        <dt>Thing Link</dt>
        <dd>
            <span class="rfc2119-assertion" id="exploration-link-description-type"> 
                A TD which describes a reference to another TD MUST use type `ThingLink` from the
                discovery context or URI `https://www.w3.org/2021/wot/discovery#ThingLink`.
            </span>
            <span class="rfc2119-assertion" id="exploration-link-description-link"> 
                A Thing Link MUST define the referenced TD as a Link with
                `describedby` link relation type, `application/td+json` media type
                and `href` set to the target URL.
            </span>

            <p>
                [[[#example-td-link-type]]] is an example Thing Link.
            </p>

            <!-- Using https://tools.ietf.org/html/rfc6963 for ID of examples -->
            <aside class="example" id="example-td-link-type" title="Example of a Thing Link, referencing a remote TD">
                <pre>
                    {
                        "@context": [
                            "http://www.w3.org/ns/td",
                            "https://w3c.github.io/wot-discovery/context/discovery-context.jsonld"
                        ],
                        "@type": "ThingLink",
                        "id": "urn:example:link",
                        "links": [{
                            "rel": "describedby",
                            "href": "https://example.com/td.jsonld",
                            "type": "application/td+json"
                        }],
                        "security": "nosec_sc",
                        "securityDefinitions": {
                            "nosec_sc": {
                                "scheme": "nosec"
                            }
                        },
                        "title": "Example TD referencing another"
                    }
                </pre>
                <div class="issue" data-number="148">
                    The context URIs are tentative and subject to change.
                </div>                    
            </aside>
            <p>
                A Thing Link can be used in various scenarios. For example:
                <ul>
                    <li>
                        A self-describing Thing with limited computational resources intends
                        to describe itself: host a minimal <a>TD</a> (Thing Link) locally
                        and references a larger one with the full details hosted at a
                        different URL, perhaps in a directory.
                    </li>
                    <li>
                        A self-describing Thing or proxy has a very large or dynamic description:
                        registers a small or static <a>TD</a> (Thing Link) in a 
                        directory which references the actual <a>TD</a> hosted at the edge.
                    </li>
                    <li>
                        A device intends to publish an entire <a>TD</a> which contains private and
                        public parts: publish one <a>TD</a> (Thing Link) with only the public
                        information referencing another <a>TD</a> which contains the full description.
                    </li>
                </ul>
            </p>
        </dd>
        
        <section id="exploration-self" class="normative">
            <h2>Self-description</h2>
            <!-- <p class="ednote" title="Self-Description Overview">
            To do: Describe mechanisms for devices to self-describe, hosting their own TDs.
            </p> -->
            <p>
                The self-description is an exploration mechanism in which a <a>Thing</a>
                hosts its own <a>TD</a> and exposes it at a URL or
                through others means. 
                If exposed at a URL (e.g. over HTTP or CoAP), the URL may be advertised
                via one of the [[[#introduction-mech]]].
                The hosted <a>TD</a> may also be registered inside a <a>Thing Description Directory</a>
                as prescribed in [[[#exploration-directory]]]. 
            </p>
            
            The self-description using the following protocols must be according
            to the given specification:
            <dl>
                <dt>HTTP</dt>
                <dd>
                    <p>
                        <span class="rfc2119-assertion" id="self-http-secure"> 
                            The HTTP-based self-description SHOULD be over HTTPS (HTTP Over TLS).
                        </span>
                        <span class="rfc2119-assertion" id="self-http-access-control">
                            The server SHOULD serve the requests after performing necessary 
                            authentication and authorization.
                        </span>
                    </p>
                    <p>
                        <span class="rfc2119-assertion" id="self-http-method"> 
                            The HTTP server MUST serve the <a>TD</a> with a `GET` method.
                        </span>
                        <span class="rfc2119-assertion" id="self-http-resp">
                            A successful response MUST have 200 (OK) status, contain `application/td+json`
                            Content-Type header, and the <a>TD</a> in body.
                        </span>
                        <span class="rfc2119-assertion" id="self-http-alternate-content">
                            The server MAY provide alternative representations through
                            server-driven content negotiation, that is by honouring the 
                            request's Accept header and responding with the supported
                            TD serialization and equivalent Content-Type header.
                        </span>
                    </p>
                    <p>
                        <span class="rfc2119-assertion" id="self-http-head">
                            The HTTP server MUST respond to `HEAD` requests by returning only the headers
                            equivalent to those returned by a `GET` request to the same endpoint.
                        </span>
                        This enables clients to retrieve HTTP headers such as the Content-Length in advance 
                        to know the size of the <a>TD</a> (in bytes) and decide on an efficient query strategy.
                    </p>
                    
                    <p>
                        Error responses:  
                        <ul>
                            <li>
                                401 (Unauthorized): No authentication.
                            </li>
                            <li>
                                403 (Forbidden): Insufficient rights to the resource.
                            </li>
                        </ul>
                    </p>
                </dd>
            </dl>
            <!-- add additional protocols for self-description here -->

        </section>
        <section id="exploration-directory" class="normative">
            <h2>Directory</h2>
            <p class="ednote" title="Directory Overview">
            To do: Describe mechanisms for TDs to be hosted in a searchable directory service.
            </p>

            <section id="exploration-directory-info" class="normative">
                <h3>Information Model</h3>
                <p class="ednote" title="Directory Information Model">
                To Do: Formal definition of information contained in a directory and its organization.
                </p>

                As shown in [[[#exploration-class-diagram]]], 
                the <a>Thing Description Directory</a> can contain zero or more <a>TDs</a>.
                For every TD, the directory maintains additional metadata
                for bookkeeping and search purposes.
                These are described in
                [[[#exploration-directory-registration-info]]] and
                [[[#exploration-directory-anonymous-td]]].
                A <a>TD</a> that embeds such additional metadata as part of the
                interaction with the directory is called an <a>Enriched TD</a>.

                <section id="exploration-directory-registration-info" class="normative">
                    <h4>Registration Information</h4>
                    The ontology of a <a>TD</a> in the Discovery context was
                    introduced in [[[#discovery-class-diagram-ontology]]].
                    The `RegistrationInformation` class is associated with <a>TDs</a> that are
                    stored in a directory. 
                    The following table lists the registration information attributes for
                    use within <a>TDs</a> that embed or reference the Discovery context. 
                    Note that only an <a>Enriched TD</a> embeds the registration information.
                    In this table,
                    client refers to the producer or consumer of a <a>TD</a> and server refers to
                    the <a>Thing Description Directory</a>.
                    <table class="def">
                        <thead>
                            <tr>
                                <th>Vocabulary term</th>
                                <th>Description</th>
                                <th>Client Assignment</th>
                                <th>Server Assignment</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="rfc2119-table-assertion" id="tdd-registrationinfo-vocab-created">
                                <td><code>created</code></td>
                                <td>
                                    Provides information when the TD instance was
                                    created inside the directory.
                                    <p>
                                        This MAY be set by the directory and returned to consumers.
                                    </p>
                                </td>
                                <td>read-only</td>
                                <td>optional</td>
                                <td><a href="http://www.w3.org/TR/2012/REC-xmlschema11-2-20120405/#dateTime"><code>dateTime</code></a></td>
                            </tr>
                            <tr class="rfc2119-table-assertion" id="tdd-registrationinfo-vocab-modified">
                                <td><code>modified</code></td>
                                <td>
                                    Provides information when the TD instance was
                                    last modified inside the directory.
                                    <p>
                                        This MAY be set by the directory and returned to consumers.
                                    </p>
                                </td>
                                <td>read-only</td>
                                <td>optional</td>
                                <td><a href="http://www.w3.org/TR/2012/REC-xmlschema11-2-20120405/#dateTime"><code>dateTime</code></a></td>
                            </tr>
                            <tr class="rfc2119-table-assertion" id="tdd-registrationinfo-vocab-expires">
                                <td><code>expires</code></td>
                                <td>
                                    Provides the absolute time for when the TD instance registration expires.
                                    <p>
                                        The producer MAY set this to indicate the absolute expiry time
                                        during the registration.
                                    </p>
                                    <p>
                                        For servers that support expirable TDs:
                                        If `ttl` (relative expiry) is present, the server MUST ignore
                                        client assignments to `expires` and instead compute and set it internally.
                                    </p>
                                </td>
                                <td>optional</td>
                                <td>optional</td>
                                <td><a href="http://www.w3.org/TR/2012/REC-xmlschema11-2-20120405/#dateTime"><code>dateTime</code></a></td>
                            </tr>
                            <tr class="rfc2119-table-assertion" id="tdd-registrationinfo-vocab-ttl">
                                <td><code>ttl</code></td>
                                <td>
                                    Time-to-live: relative amount of time in seconds from the registration time 
                                    until when the TD instance registration expires. 
                                    <p>
                                        The producer MAY set this to indicate the relative expiry time
                                        during the registration.
                                    </p>
                                    <p>
                                        For servers that support expirable TDs:
                                        The server MUST use `ttl` to calculate the `expires` (relative expiry) value.
                                    </p>
                                </td>
                                <td>optional</td>
                                <td>read-only</td>
                                <td><code>number</code></a></td>
                            </tr>
                            <tr class="rfc2119-table-assertion" id="tdd-registrationinfo-vocab-retrieved">
                                <td><code>retrieved</code></td>
                                <td>
                                    The time at which the TD was retrieved from the server.
                                    <p>
                                        This is useful for clients that intend to process other absolute timestamps but
                                        do not have an internal clock or other means of acquiring the current time.
                                    </p>
                                </td>
                                <td>read-only</td>
                                <td>optional</td>
                                <td><a href="http://www.w3.org/TR/2012/REC-xmlschema11-2-20120405/#dateTime"><code>dateTime</code></a></td>
                            </tr>
                        </tbody>
                    </table>
                </section>
                <section id="exploration-directory-registration-expiry" class="normative">
                    <h4>Registration Expiry</h4>
                    Section [[[#exploration-directory-registration-info]]] introduces few attributes to
                    specify and discover the expiry time of registered <a>TDs</a>. 

                    <p>
                        Producers can set the expiry time to inform the directory and other consumers
                        about the validity of the TD registrations. 
                        The expiry is also a useful indicator to inform the consumers about
                        expiry of dynamic <a>TDs</a>, e.g. when changes to metadata such as
                        geolocation or properties are expected to be valid for a limited period.
                        Consumers may rely on the expiry time to know how long a retrieved <a>TD</a>
                        will be valid and when they need to request a more recent one.
                        Consumers who retrieve an expired TD may consider it as metadata of an
                        inactive client.
                    </p>
                    <p>
                        For the servers, the expiry time is useful for implementing automatic
                        removal of obsolete or accidental registrations.
                        <span class="rfc2119-assertion" id="tdd-registrationinfo-expiry-purge">
                            Servers SHOULD periodically purge TDs that are past 
                            their expiry times.
                        </span>
                        Prescribing a global mandate or upper limit for the expiry time is
                        application-specific and beyond the scope of this specification.
                        <span class="rfc2119-assertion" id="tdd-registrationinfo-expiry-config">
                            The servers MAY mandate or set a configurable upper limit to expiry times
                            and refuse incompliant requests.
                        </span>
                        
                        The purging by servers is particularly beneficial when interacting with
                        clients (e.g. IoT devices) that are unable to explicitly deregister
                        their <a>TDs</a>. This could be due to protocol-specific limitations,
                        failure, destruction, or ungraceful decommissioning.
                        Such clients should set a reasonably short expiry time and periodically
                        extend it during the normal operation.
                       
                        If a client ceases to operate, a directory with purging capability will
                        automatically remove its registration.
                    </p>
                        
                </section>
                <section id="exploration-directory-anonymous-td" class="normative">
                    <h4>Anonymous TD Identifiers</h4>
                    The directory assigns local identifiers to <a>Anonymous TDs</a>
                    to enable management and retrieval of such TDs from the directory.
                    <span class="rfc2119-assertion" id="tdd-reg-anonymous-td-identifier">
                        In situations where the server exposes an Anonymous TD (e.g. retrieval, listing, search),
                        it MUST add the local identifier to the TD to allow local referencing.
                    </span>

                    <span class="rfc2119-assertion" id="tdd-reg-anonymous-td-local-id">
                        The local identifier SHOULD be a UUID Version 4, presented as a URN [[RFC4122]].
                    </span>
                    UUID Version 4 is a random or pseudo-random number which does not carry unintended information
                    about the host or the resource.
                </section>
            </section>
            <section id="exploration-directory-api" class="normative">
                <h3>Directory Service API</h3>
                The Directory APIs must use secure protocols guaranteeing 
                <a href="https://www.w3.org/TR/wot-security/#dfn-system-user-data">System User Data</a> 
                authenticity and confidentiality (see [[?WOT-SECURITY]]).
                <span class="rfc2119-assertion" id="tdd-https"> 
                    The HTTP API MUST be exposed over HTTPS (HTTP Over TLS).
                </span>
                <p>
                    The HTTP API responses must use appropriate status codes described in 
                    this section for success and error responses.
                    <span class="rfc2119-assertion" id="tdd-http-error-response"> 
                        The HTTP API MUST use the Problem Details [[RFC7807]] format to carry
                        error details in HTTP client error (4xx) and server error (5xx) responses.
                    </span>
                    This enables both machines and humans to know the high-level error class
                    and fine-grained details.
                </p>

                <p class="ednote" title="WoT-specific error types">
                    The Problem Details error `type` field is a URI reference which 
                    could used to map the occurred error to WoT-specific error class. 
                    There are few open issues raising the lack of WoT-specific error types:
                    <a href="https://github.com/w3c/wot-discovery/issues/44">wot-discovery#44</a>,
                    <a href="https://github.com/w3c/wot-thing-description/issues/303">wot-thing-description#303</a>,
                    <a href="https://github.com/w3c/wot-scripting-api/issues/200">wot-scripting-api#200</a>.
                    <br>
                    For now, `type` can be omitted which defaults to "about:blank", and `title`
                    should be set to HTTP status text.
                </p>
                
                <p>
                    <span class="rfc2119-assertion" id="tdd-http-head"> 
                        For each HTTP endpoint that responds to the `GET` method, the server MUST accept `HEAD` 
                        requests and return only the headers.
                    </span>
                    This allows clients to retrieve headers such as the Content-Length without receiving the body
                    and decide on a suitable strategy to query the information. For example, a constrained client can
                    request only the necessary parts of an object (using an apprpriate search query) or 
                    retrieve a list of items in small subsets.
                </p>

                <section id="exploration-directory-api-registration" class="normative">
                    <h4>Registration</h4>
                    <p>
                        The Registration API is a RESTful HTTP API in accordance with the recommendations
                        defined in [[RFC7231]] and [[?REST-IOT]].
                        <span class="rfc2119-assertion" id="tdd-reg-default-representation">
                            The default serialization format for all request and success response bodies MUST be
                            JSON, with JSON-LD 1.1 [[JSON-LD11]] syntax to support extensions and semantic
                            processing.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-reg-additional-representation">
                            Directories MAY accept additional representations based on request's indicated
                            Content-Type or Content-Encoding, and provide additional representations through
                            server-driven content negotiation.
                        </span>
                    </p>
                    <p>
                        <span class="rfc2119-assertion" id="tdd-reg-crudl">
                            The Registration API MUST provide create, retrieve, update, delete, and listing (CRUDL) interfaces. 
                        </span>

                        The operations are described below:
                    </p>

                    <section id="exploration-directory-api-registration-creation" class="normative">
                        <h4>Creation</h4>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-create-body">
                                The API MUST allow registration of a TD object passed as request body.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-create-contenttype">
                                The request SHOULD contain `application/td+json` Content-Type header for 
                                JSON serialization of TD.
                            </span>
                            The TD object is validated in accordance with [[[#validation]]].
                            Note that a TD may or may not be generated by the <a>Thing</a> it describes.
                            For brownfield devices in particular a separate <a>Discoverer</a> process
                            or service may be required that generates and registers a TD for a <a>Thing</a>
                            on its behalf.
                        </p>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-create-known-vs-anonymous"> 
                                A TD which is identified with an `id` attribute MUST be handled 
                                differently with one that has no identifier (<a>Anonymous TD</a>).
                            </span>
                            The create operations are elaborated below:
                        </p>
                        <ul>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-create-known-td">
                                    A TD MUST be submitted to the directory using an HTTP `PUT` request
                                    at `/things/{id}` endpoint, where `id` is the unique TD identifier. 
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-create-known-td-resp">  
                                    Upon successful processing, the server MUST respond with
                                    201 (Created) status.                           
                                </span>

                                <p>
                                    Note: If the target location corresponds to an existing TD,
                                    the request shall instead proceed as an Update operation and respond
                                    the appropriate status code (see Update section).
                                </p>
                                <p>
                                    The create operation for <a>TDs</a> that have identifiers is specified
                                    as `createThing` action in [[[#directory-thing-description]]]. 
                                </p>
                            </li>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-create-anonymous-td">
                                    An <a>Anonymous TD</a> MUST be submitted to the directory using an HTTP `POST` request
                                    at `/things` endpoint.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-create-anonymous-td-resp">
                                    Upon successful processing, the server MUST respond with 201 (Created) status
                                    and a Location header containing a system-generated identifier for the TD.
                                </span>
                                The scheme of the system-generated ID is described in [[[#exploration-directory-anonymous-td]]].

                                <p>
                                    The create operation for <a>Anonymous TDs</a> is specified as `createAnonymousThing` action in
                                    [[[#directory-thing-description]]].
                                </p>
                            </li>
                        </ul>

                        <p>
                            A server that supports expirable TDs will realize such functionality
                            as described in [[[#exploration-directory-registration-expiry]]].
                            In particular, if `ttl` (relative expiry) is given during the creation,
                            such servers will calculate and store the `expires` value.
                        </p>

                        <p>
                            Error responses:
                            <ul>
                                <li>
                                    400 (Bad Request): Invalid serialization or TD.
                                    This is accompanied by an appropriate response message.
                                </li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                            </ul>
                        </p>
                      
                        <p class="issue" data-number="48">
                        </p>
                    </section>

                    <section id="exploration-directory-api-registration-retrieval" class="normative">
                        <h4>Retrieval</h4>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-retrieve">
                                A TD MUST be retrieved from the directory using an HTTP `GET` request
                                at `/things/{id}` endpoint, where `id` is the unique TD identifier.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-retrieve-resp">
                                A successful response MUST have 200 (OK) status, contain `application/td+json`
                                Content-Type header, and the requested TD in body.
                            </span>
                            <p>
                                The retrieve operation is specified as `retrieveThing` action in 
                                [[[#directory-thing-description]]].
                            </p>
                        </p>

                        <p>
                            Error responses:  
                            <ul>
                                <li>404 (Not Found): TD with the given `id` not found.</li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                            </ul>
                        </p>

                        <p>
                            The following is an example of a retrieved TD:
                            <aside class="example" id="example-enriched-td" title="Example Enriched TD">
                                <pre>
                                    {
                                        "@context": [
                                            "http://www.w3.org/ns/td",
                                            "https://w3c.github.io/wot-discovery/context/discovery-context.jsonld"
                                        ],
                                        "id": "urn:example:simple-td",
                                        "security": "basic_sc",
                                        "securityDefinitions": {
                                            "basic_sc": {
                                                "scheme": "basic"
                                            }
                                        },
                                        "registration": {
                                            "created": "2021-01-19T17:02:00Z",
                                            "modified": "2021-01-19T17:02:00Z"
                                        },
                                        "title": "Simple TD"
                                    }
                                </pre>
                                <div class="issue" data-number="148">
                                    The context URIs are tentative and subject to change.
                                </div>                    
                            </aside>
                            This is an <a>Enriched TD</a> which includes the registration information
                            such as the creation and modification time of the TD within the directory.
                        </p>
                        
                        <p>
                            The example below shows a retrieved <a>Anonymous TD</a> that is in
                            <a>Enriched TD</a> form and has local identifier `urn:uuid:48951ff3-4019-4e67-b217-dbbf011873dc`.
                            
                            <aside class="example" id="example-anonymous-enriched-td" title="Example Enriched Anonymous TD">
                                <pre>
                                    {
                                        "@context": [
                                            "http://www.w3.org/ns/td",
                                            "https://w3c.github.io/wot-discovery/context/discovery-context.jsonld"
                                        ],
                                        "id": "urn:uuid:48951ff3-4019-4e67-b217-dbbf011873dc",
                                        "security": "basic_sc",
                                        "securityDefinitions": {
                                            "basic_sc": {
                                                "scheme": "basic"
                                            }
                                        },
                                        "registration": {
                                            "created": "2021-01-19T17:02:00Z",
                                            "modified": "2021-01-19T17:02:00Z"
                                        },
                                        "title": "Anonymous TD"
                                    }
                                </pre>
                                <div class="issue" data-number="148">
                                    The context URIs are tentative and subject to change.
                                </div>                    
                            </aside>
                        </p>

                        <p>

                            The following is an example of a retrieved TD that was registered with a relative
                            expiry time of 3600 seconds (one hour). The server has calculated the absolute expiry time as 
                            one hour after the modification time.
                            <aside class="example" id="example-expirable-enriched-td" title="Example Expirable Enriched TD">
                                <pre>
                                    {
                                        "@context": [
                                            "http://www.w3.org/ns/td",
                                            "https://w3c.github.io/wot-discovery/context/discovery-context.jsonld"
                                        ],
                                        "id": "urn:example:expirable-td",
                                        "security": "basic_sc",
                                        "securityDefinitions": {
                                            "basic_sc": {
                                                "scheme": "basic"
                                            }
                                        },
                                        "registration": {
                                            "created": "2021-05-10T16:00:00Z",
                                            "modified": "2021-05-10T17:00:00Z",
                                            "expires": "2021-05-10T18:00:00Z",
                                            "ttl": 3600,
                                            "retrieved": "2021-05-10T17:35:00Z"
                                        },
                                        "title": "Expirable TD"
                                    }
                                </pre>
                                <div class="issue" data-number="148">
                                    The context URIs are tentative and subject to change.
                                </div>                    
                            </aside>
                            For the sake of readability, the time values in this example are set to exact numbers.
                            In realistic settings, time values may include fractions.
                        </p>

                    </section>

                    <section id="exploration-directory-api-registration-update" class="normative">
                        <h4>Update</h4>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-update-types">
                                The API MUST allow modifications to an existing TD as full replacement or partial updates.
                            </span>
                            The update operations are described below:
                        </p>

                        <ul>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-update">
                                    A modified TD MUST replace an existing one when submitted using an HTTP `PUT` request
                                    at `/things/{id}` endpoint, where `id` is the identifier of the existing TD.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-contenttype">
                                    The request SHOULD contain `application/td+json` Content-Type header for JSON
                                    serialization of TD.
                                </span>
                                The TD object is validated in accordance with [[[#validation]]].
                                <span class="rfc2119-assertion" id="tdd-reg-update-resp">
                                    Upon success, the server MUST respond with 204 (No Content) status. 
                                </span>

                                <p>
                                    A server that supports expirable TDs will realize such functionality
                                    as described in [[[#exploration-directory-registration-expiry]]].
                                    If `ttl` (relative expiry) is set during the update operation,
                                    the server will calculate and set the `expires` (absolute expiry) value.
                                </p>

                                <p>
                                    This operation is specified as `updateThing` property in 
                                    [[[#directory-thing-description]]].
                                </p>
                                

                                <p>
                                    Note: If the target location does not correspond to an existing TD,
                                    the request shall instead proceed as a Create operation and respond
                                    the appropriate status code (see Create section). In other words, an HTTP `PUT`
                                    request acts as a create or update operation.
                                </p>
                            </li>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial">
                                    An existing TD MUST be partially modified when the modified parts are submitted using an 
                                    HTTP `PATCH` request
                                    at `/things/{id}` endpoint, where `id` is the identifier of the existing TD.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-mergepatch">
                                    The partial update MUST be processed using the JSON merge patch format 
                                    format described in [[RFC7396]].
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-contenttype">
                                    The request MUST contain `application/merge-patch+json` Content-Type header for JSON
                                    serialization of the merge patch document.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-partialtd">
                                    The input MUST be in <a>Partial TD</a> form and conform to the
                                    original TD structure. 
                                </span>
                                
                                If the input contains members that appear in the original TD, 
                                their values are replaced. If a member do not appear in the 
                                original TD, that member is added. If the member is set to `null` 
                                but appear in the original TD, that member is removed. 
                                Members with object values are processed recursively.
                                
                                After applying the modifications, the TD object is validated in accordance with [[[#validation]]].
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-resp">
                                    Upon success, the server MUST respond with a 204 (No Content) status.
                                </span>

                                <p>
                                    A server that supports expirable TDs will realize such functionality
                                    as described in [[[#exploration-directory-registration-expiry]]].
                                    During the partial update operation, if the resulting <a>TD</a> has 
                                    `ttl` (relative expiry), the server will calculate and set a new
                                    `expires` (absolute expiry) value.
                                </p>

                                <p>
                                    This operation is specified as `partiallyUpdateThing` property in 
                                    [[[#directory-thing-description]]].
                                </p>
                                

                                <p>
                                    The following example is a merge patch document to update only the
                                    `base` and registration `expires` fields of a TD:
                                    <aside class="example" id="example-patch-enriched-td" title="Example merge patch document">
                                        <pre>
                                            {
                                                "base": "http://192.168.0.2/",
                                                "registration": {
                                                    "expires": "2021-01-20T17:02:00Z"
                                                }
                                            }
                                        </pre>                    
                                    </aside>
                                </p>
                            </li>
                        </ul>

                        <p>
                            Error responses:
                            <ul>
                                <li>
                                    400 (Bad Request): Invalid serialization or TD.
                                    This is accompanied by an appropriate response message.
                                </li>
                                <li>404 (Not Found): TD with the given `id` not found (for `PATCH` only).</li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                            </ul>
                        </p>
                    </section>

                    <section id="exploration-directory-api-registration-deletion" class="normative">
                        <h4>Deletion</h4>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-delete">
                                A TD MUST be removed from the directory when an HTTP `DELETE` request is submitted
                                at `/things/{id}`, where `id` is the identifier of the existing TD.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-delete-resp">
                                A successful response MUST have 204 (No Content) status.
                            </span>
                            The retrieve operation is specified as `deleteThing` property in
                            [[[#directory-thing-description]]].
                        </p>

                        <p>
                            Error responses:
                            <ul>
                                <li>404 (Not Found): TD with the given `id` not found.</li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                            </ul>
                        </p>
                    </section>

                    <section id="exploration-directory-api-registration-listing" class="normative">
                        <h4>Listing</h4>
                        <p>
                            The listing endpoint provides different ways to query the collection of full TD objects
                            from the directory.
                        </p>
                        <p>
                            In many scenarios, retrieving parts instead of full TD objects is preferred because
                            only a subset of elements are needed (e.g. `id` and `href` of a property for all TDs)
                            and to save networking resources. The Search API allows querying parts of TD objects;
                            see [[[#exploration-directory-api-search]]].
                        </p>
                        
                            
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-list-method">
                                The list of TDs MUST be retrieved from the directory using an HTTP `GET` request
                                at `/things` endpoint.
                            </span>
                        
                            <span class="rfc2119-assertion" id="tdd-reg-list-resp">
                                A successful response MUST have 200 (OK) status, contain `application/ld+json`
                                Content-Type header, and an array of TDs in the body.
                            </span>

                        </p>

                        <p>
                            There may be scenarios in which clients need to retrieve the collection
                            in small subsets of TDs. 
                            While the Search API ([[[#exploration-directory-api-search]]])
                            does offer the ability to query a specific range, it may not be optimal,
                            nor developer-friendly.
                            
                            <span class="rfc2119-assertion" id="tdd-reg-list-pagination">
                                The server MAY support pagination to return the collection
                                in small subsets.
                            </span>
                            The pagination must be based on the following rules:
                            <ul>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-limit">
                                        When the `limit` query parameter is set to a positive integer,
                                        the server MAY respond with a subset of TDs totalling
                                        to less than or equal to the requested number.
                                    </span>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-header-nextlink">
                                        When there are more TDs after a returned subset of the collection,
                                        the response MUST contain a `next` Link header [[RFC8288]]
                                        with the URL of the next subset.
                                    </span>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-header-nextlink-attr">
                                        The `next` link MUST have the same `limit` argument given on the initial
                                        request as well as a zero-based `offset` argument anchored at
                                        the beginning of the next subset.
                                    </span>
                                    The link may be absolute or relative to directory API's base URL.
                                    Moreover, it may include additional arguments that are necessary for
                                    ordering or session management.
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-header-canonicallink">
                                        All paged responses MUST contain a `canonical` Link header [[RFC8288]]
                                        pointing to the collection and include an `etag` parameter to represent
                                        the current state of the collection.
                                    </span>
                                    The link may be absolute or relative to directory API's base URL.
                                    The `etag` value could be a revision number, timestamp, or UUID Version 4,
                                    set whenever the TD collection changes in a way that affects the
                                    ordering of the TDs. 
                                    The clients may rely on the `etag` value to know whether the collection
                                    remains consistent across paginated retrieval of the collection.
                                    For example, creation or deletion of TDs or update of TD fields used for
                                    ordering may make shift the calculated paging window.
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-order-default">
                                        By default, the collection MUST be sorted alphanumerically 
                                        by the unique identifier of TDs.
                                    </span>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-order">
                                        The server MAY support sorting by other TD attributes using
                                        query arguments: `sort_by` to select a field (e.g. `created`)
                                        and `sort_order` to choose the order
                                        (i.e. `asc` or `desc` for ascending and descending ordering).
                                    </span>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-order-unsupported">
                                        If the server does not support custom sorting,
                                        it MUST reject the request with 501 (Not Implemented) status.
                                    </span>
                                    <span class="rfc2119-assertion" id="tdd-reg-list-pagination-order-nextlink">
                                        If sorting attributes are accepted, they MUST be added consistently to all `next` links.
                                    </span>
                                </li>
                            </ul>
                            <p>
                                This above specification follows a subset of Linked Data Paging [[?LDP-Paging]]
                                to allow optional pagination of the JSON-LD array.
                                Additional parts of Linked Data Paging may be implemented for examples
                                to honour client's query preference or to add other link relations for semantic
                                annotation and alternative navigation links.
                            </p>
                            
                            The following example provides a walk-through of the paginated
                            retrieval of TDs:
                            
                            <aside class="example" id="example-pagination"
                                title="Query all TDs with page size 10.">
                                The client requests the list with a `limit` of 10:
                                <pre>
                                    GET /things?limit=10 HTTP/1.1   
                                    Host: tdd.example.com
                                </pre>
                                Response:
                                <pre>
                                    HTTP/1.1 200 OK
                                    Content-Type: application/ld+json
                                    Link: &#x3C;/things?offset=10&#x26;limit=10&#x3E;; rel=&#x22;next&#x22;
                                    Link: &#x3C;/things&#x3E;; rel=&#x22;canonical&#x22;; etag=&#x22;v1&#x22;

                                    [{ TD }, ...9 other TDs... ]
                                </pre>
                                The response includes two Link headers with relative URLs:
                                `next` link to query the remaining TDs,
                                `canonical` link referencing the full collection with `etag` value indicating
                                the state of that collection.
                                <br>
                                The response body is an array of 10 TDs.
                                
                                <br><br>
                                The presence of the `next` link implies that subsequent pages should be
                                queried for the remaining TDs.
                                The client requests the next page via the `next` link:
                                <pre>
                                    GET /things?offset=10&limit=10 HTTP/1.1   
                                    Host: tdd.example.com
                                </pre>

                                Response:
                                <pre>
                                    HTTP/1.1 200 OK
                                    Content-Type: application/ld+json
                                    Link: &#x3C;/things&#x3E;; rel=&#x22;canonical&#x22;; etag=&#x22;v1&#x22;
    
                                    [{ TD }, { TD }]
                                </pre>
                                The server response has the remaining two TDs. There is no `next` link,
                                because this is the last page. The `etag` value has not changed implying
                                that the collection has remained consistent between the two requests.
                                <br><br>
                                The client has retrieved the whole collection, containing 12 TDs.
                            </aside>
                        </p>

						<p>
							Alternative to a pure array of TDs as the body of the response, the server MAY
							send a more verbose payload allowing server-side information, like pagination
							information, to be put in addition to the actual data.
						</p>
							
						<p>
							For pagination information the alternative format leans against the formats as described
							in <a href="https://www.hydra-cg.com/spec/latest/core/#advanced-concepts">
							Hydra Advanced Concepts</a>, more concretely the
							<a href="https://www.hydra-cg.com/spec/latest/core/#example-20-a-hydra-partialcollectionview-splits-a-collection-into-multiple-views">
							Partial Collection View</a>. Adapted to our purposes and using the <i>members</i> field to accomodate the array
							of TDs, it looks like as follows for the listing endpoint:
						</p>
						<p>
							<aside class="example" id="example-alternative-payload"
								title="Alternative payload format including pagination information">
								<pre>
									{
										"@context": "https://w3c.github.io/wot-discovery/context/discovery-context.jsonld",
										"@type": "ThingCollection",
										"total: 12,
										"members": [
											{ TD },
											9 other TDs...
										],
										"@id": "/things?offset=0&limit=10&format=collection",
										"next": "/things?offset=10&limit=10&format=collection"
									}
								</pre>                    
							</aside>
						</p>
						
						<p>
							To tell the server which format to send, the additional query parameter <code>?format=array|collection</code>
							can be added to the request. <code>?format=array</code> is the default parameter, does not have to be provided
							explicitly, and yields to a server response of the pure array of TDs. <code>?format=collection</code>
							should yield to a server response with the format as described in [[[#example-alternative-payload]]].
						</p>
						
                        <p>
                            Serializing and returning the full list of TDs may be burdensome to servers.
                            As such, servers should serialize incrementally and utilize protocol-specific
                            mechanisms to respond in chunks. 
                            <span class="rfc2119-assertion" id="tdd-reg-list-http11-chunks">
                                HTTP/1.1 servers SHOULD perform chunked 
                                <a href="https://tools.ietf.org/html/rfc7230#section-3.3.1">Transfer-Encoding</a> [[RFC7230]]
                                to respond the data incrementally.
                            </span>
                            Most HTTP/1.1 clients automatically process the data received with 
                            chunked transfer encoding.
                            Memory-constrained applications which require the full list
                            should consider processing the received data incrementally.

                            Chunked transfer encoding is not supported in HTTP/2.
                            <span class="rfc2119-assertion" id="tdd-reg-list-http2-frames">
                                HTTP/2 servers SHOULD respond the data incrementally using 
                                <a href="https://tools.ietf.org/html/rfc7540#section-4">HTTP Frames</a> [[RFC7540]].
                            </span>
                        </p>

                        <p>    
                            The listing operation is specified as `things` property in 
                            [[[#directory-thing-description]]].
                        </p>

                        <p>
                            Error responses:  
                            <ul>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                            </ul>
                        </p>

                        
                    </section>

                    <section id="validation" class="normative">
                        <h4>Validation</h4>
                        <p>
                           <span class="rfc2119-assertion" id="tdd-validation-syntactic">
                                The syntactic validation of TD objects before storage is RECOMMENDED to
                                prevent common erroneous submissions.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-validation-jsonschema">
                                The server MAY use
                                <a href="https://www.w3.org/TR/wot-thing-description/#json-schema-for-validation">Thing Description JSON Schema</a>
                                to validate standard TD vocabulary, or a more comprehensive JSON Schema to also validate extensions.
                            </span>
                        </p>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-validation-result">
                                If the server fails to validate the TD object, it MUST inform the client
                                with necessary details to identify and resolve the errors.
                            </span>
    
                            <span class="rfc2119-assertion" id="tdd-validation-response">
                                The validation error MUST be described as Problem Details [[RFC7807]]
                                with an extension field called `validationErrors`, set to an array of objects
                                with `field` and `description` fields.
                            </span>
                            This is necessary to represent the error in a machine-readable way. 
                        </p>
                        
                        [[[#example-validation-error]]] is an example error response with two validation errors.
                        <aside class="example" id="example-validation-error" title="Example validation error response">
                            <pre>
                                {
                                    "title": "Bad Request",
                                    "status": 400,
                                    "detail": "The input did not pass the JSON Schema validation",
                                    "instance": "/errors/30585584-cce2-4d04-8079-67b33ffdafbc",
                                    "validationErrors": [
                                        {
                                            "field": "(root)",
                                            "description": "security is required"
                                        },
                                        {
                                            "field": "properties.status.forms.0.href",
                                            "description": "Invalid type. Expected: string, given: integer"
                                        }
                                    ]
                                }                      
                            </pre>
                            <p class="ednote" title="Validation error type">
                                This example skips the `type` field 
                                due to the current lack of specific error types. 
                                See notes in [[[#exploration-directory-api]]].
                            </p>
                        </aside>
                        
                        

                        <div class="issue" data-number="99"></div>
                    </section>

                </section>
                <section id="exploration-directory-api-management" class="normative">
                    <h4>Management</h4>
                    <p class="ednote" title="Management API">
                        To do: Other administrative functions not having to do with CRUD of individual records,
                        for example, security configuration.
                        Also, administrator roles may expand the capabilities of administrators for
                        management of records (for instance, the ability to delete a record they did not create).
                    </p>
                </section>
                <section id="exploration-directory-api-notification" class="normative">
                    <h4>Notification</h4>

                    <p>The Notification API is to notify clients about the changes
                        to Thing Descriptions maintained within the directory.
                        <span class="rfc2119-assertion" id="tdd-notification-sse">
                            The Notification API MUST follow the Server-Sent Events [[EVENTSOURCE]]
                            specifications to serve events to clients
                            at `/events` endpoint.
                        </span>
                        In particular, the server responds to successful requests with 200 (OK) status
                        and `text/event-stream` Content Type.
                        Re-connecting clients may continue from
                        the last event by providing the last event ID as `Last-Event-ID` header value.
                        <span class="rfc2119-assertion" id="tdd-notification-event-id">
                            The server SHOULD provide an event ID as the `id` field in each event
                            and respond to re-connecting clients by delivering all missed events.
                        </span>
                    </p>

                    <dl>
                        <dt>Event Types</dt>
                        <dd>
                            <span class="rfc2119-assertion" id="tdd-notification-event-types">
                                The server MUST produce events attributed to the lifecycle of 
                                the Thing Descriptions within the directory using 
                                `create`, `update`, and `delete` event types.
                            </span>
                        </dd>

                        <dt>Event Filtering</dt>
                        <dd>
                            The API enables server-side filtering of events to reduce resource consumption
                            by delivering only the events required by clients.
                            Client libraries may offer additional filtering capabilities on
                            the client-side.

                            <p>
                                <span class="rfc2119-assertion" id="tdd-notification-filter-type">
                                    The server MUST support event filtering based on the 
                                    event type given by the client upon subscription. 
                                </span>
                            </p>
                            <p>
                                For example, given the URI Template `/events{/type}`:
                                <ul>
                                    <li>
                                        `/events/create` instructs the server to only deliver events of
                                        type `create`
                                    </li>
                                    <li>
                                        `/events` instructs the server to deliver all events
                                    </li>
                                </ul>
                                The clients need to subscribe separately to receive a subset of
                                the events (e.g. only `create` and `delete`) from the server. 
                                When using HTTP/2, multiple subscriptions on the same domain (HTTP streams) 
                                get multiplexed on a single connection.
                            </p>


                            <div class="issue" data-number="176">
                                Event filtering based on the payload is work in progress. 
                            </div>
                        </dd>
                        <dt>Event Data</dt>
                        <dd>
                            <span class="rfc2119-assertion" id="tdd-notification-data">
                                The event data MUST contain the JSON serialization of the event object.
                            </span>
                            The event data object is a <a>Partial TD</a> or the whole <a>TD</a> object
                            depending on the request:
                            <ul>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-td-id">
                                        The event data object MUST at least include the identifier of the
                                        TD created, updated, or deleted at that event in <a>Partial TD</a> form.
                                    </span>

                                    <aside class="example" title="Creation and deletion SSE events for a TD">
                                        <pre>
                                            event: create
                                            data: {"id": "urn:example:simple-td"}
                                            id: event_1

                                            event: delete
                                            data: {"id": "urn:example:simple-td"}
                                            id: event_2
                                        </pre>
                                    </aside>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-create-full">
                                        When `diff` query parameter is set to `true` and the event has `create` type,
                                        the server MAY return the whole TD object as event data.
                                    </span>
                                    
                                    <aside class="example" id="example-create-event-full" title="Full creation SSE event for a TD">
                                        <pre>
                                            event: create
                                            data: {
                                            data:     "@context": [
                                            data:         "https://www.w3.org/2019/wot/td/v1",
                                            data:         "https://w3c.github.io/wot-discovery/context/discovery-context.jsonld"
                                            data:     ],
                                            data:     "description": "This is a new TD",
                                            data:     "id": "urn:example:simple-td",
                                            data:     "security": "basic_sc",
                                            data:     "securityDefinitions": {
                                            data:         "basic_sc": {
                                            data:             "scheme": "basic"
                                            data:         }
                                            data:     },
                                            data:     "registration": {
                                            data:         "created": "2021-01-19T17:02:00Z",
                                            data:         "modified": "2021-01-19T17:02:00Z"
                                            data:     },
                                            data:     "title": "Simple TD"
                                            data: }
                                            id: event_1
                                        </pre>
                                        <div class="issue" data-number="148">
                                            The context URIs are tentative and subject to change.
                                        </div>
                                    </aside>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-update-diff">
                                        When `diff` query parameter is set to `true` and the event has `update` type,
                                        the server MAY inform the client about the updated parts following the
                                        JSON Merge Patch [[RFC7396]] format.
                                    </span>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-update-id">
                                        An `update` event data that is based on JSON Merge Patch [[RFC7396]]
                                        MUST always include the identifier of the TD regardless of whether it
                                        is changed.
                                    </span>

                                    <p>
                                        The following example shows the event triggered on update of the TD from [[[#example-create-event-full]]]:
                                        <aside class="example" id="example-update-event-full" 
                                            title="Full update SSE event for a TD with removed description and changed title">
                                            <pre>
                                                event: create
                                                data: {
                                                data:     "description": null,
                                                data:     "id": "urn:example:simple-td",
                                                data:     "title": "Updated TD"
                                                data: }
                                                id: event_3
                                            </pre>
                                        </aside>
                                    </p>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-delete-diff">
                                        The `diff` query parameter MUST be ignored for `delete` events.
                                    </span>
                                    In other words, the server does not need to include additional properties in
                                    the payload of `delete` events when `diff` is set to `true`. 
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-diff-unsupported">
                                        When a server which does not support the `diff` query parameter 
                                        is requested with such query parameter, it MUST
                                        reject the request with 501 (Not Implemented) status.
                                    </span>
                                    This is to inform the clients about the lack of such functionality at the
                                    connection time to avoid runtime exceptions caused by missing
                                    event data attributes.
                                </li>
                            </ul>
                        </dd>
                    </dl>
                    <p>
                        The Notification API is specified as three event affordances in
                        [[[#directory-thing-description]]], namely:
                        `thingCreation`, `thingUpdate`, and `thingDeletion`.
                    </p>

                    <p class="ednote" title="SSE Authorization Header">
                        Some early SSE implementations (including HTML5 EventSource) do not allow
                        setting custom headers in the initial HTTP request. Authorization header 
                        is required in few OAuth2 flows and passing it as a query parameter is
                        <a href="https://tools.ietf.org/html/rfc6750#section-2.3">not advised</a>.

                        There are polyfills for browsers and modern libraries which allow 
                        setting Authorization header.
                    </p>
                    

                </section>
                <section id="exploration-directory-api-search" class="normative">
                    <h4>Search</h4>
                    
                    <p class="ednote" title="Search API Overview">
                        Sub-API to search a directory, e.g. issue a query.
                        There are different forms and levels of query possible, including both
                        syntactic and semantic queries.
                        In general, query types are optional and all query types do not need to be 
                        supported by all directories - or at all.
                        This API has subsections for each query type.
                        Search also includes a sub-API for managing listing the contents (eg returned by
                        a query) including handling pagination, etc.
                        There is also one special form of query able to return the entire contents of
			the directory.
                        Results may be subject to the requestor's authorization, and this query form is
			only suitable for small directories.  Larger directories (with, for instance,
			more than a hundred or so entries) should implement some form of query.
                        <br>
                        To discuss further:
                        Federated queries to other TDDs, Spatial and network-limited queries, Links
                    </p>
                    The Directory has three search APIs: syntactic search with JSONPath [[?JSONPATH]]
                    or XPath [[xpath-31]], and semantic search with SPARQL [[sparql11-overview]].
                    <span class="rfc2119-assertion" id="tdd-search-xpath">
                        The Directory MAY implement the syntactic search with XPath.
                    </span>
                    <span class="rfc2119-assertion" id="tdd-search-sparql">
                        The Directory MAY implement semantic search with SPARQL.
                    </span>
                    In addition, in the future Directories may support syntactic search with JSONPath,
		    but this its specification is still in a draft status.  We document in an informative
		    manner a JSONPath entry point.  
    		
                    <section id="jsonpath-semantic" class="informative">
                        <h4>Syntactic search: JSONPath</h4>
			To do: The JSONPath subAPI is optional and informative, so it is not appropriate to
			have RFC assertions here.  They will have to be reworded.
                        <span class="rfc2119-assertion" id="tdd-search-jsonpath-method">
                            The JSONPath API MUST allow searching TDs using an HTTP <code>GET</code> request
                            at `/search/jsonpath?query={query}` endpoint, where `query` is the JSONPath expression.
                        </span> 
                        <span class="rfc2119-assertion" id="tdd-search-jsonpath-parameter">
                            The request MUST contain a valid JSONPath [[?JSONPATH]] as searching parameter.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-search-jsonpath-response">
                            A successful response MUST have 200 (OK) status, contain
                            <code>application/json</code> Content-Type header, and in
                            the body a set of complete TDs or a set of TD fragments.
                        </span>
                        The syntactic search with JSONPath is specified as `searchJSONPath` action in
                        [[[#directory-thing-description]]].

                        <p>List of errors:
                            <ul>
                                <li>400 (Bad Request): JSONPath expression not provided or contains syntax errors.</li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                            </ul>
                        </p>
                        <div class="issue" data-number="56">
                            The standardization of JSONPath expressions is in progress by an independent working group.
                        </div>
                    </section>
                    <section id="xpath-semantic" class="normative">
                        <h4>Syntactic search: XPath</h4>
                        The support for XPath Search API is recommended.
                        <span class="rfc2119-assertion" id="tdd-search-xpath-method">
                            If implemented, the XPath query API MUST allow searching TDs using an
                            HTTP <code>GET</code> request
                            at `/search/xpath?query={query}` endpoint, where `query` is the XPath expression.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-search-xpath-parameter">
                            The request MUST contain a valid XPath [[xpath-31]] as search parameter.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-search-xpath-response">
                            A successful response MUST have 200 (OK) status, contain
                            <code>application/json</code> Content-Type header, and in
                            the body a set of complete TDs or a set of TD fragments.
                        </span>
                        The syntactic search with XPath is specified as `searchXPath` action in
                        [[[#directory-thing-description]]].
                                
                        <p>List of errors:
                            <ul>
                                <li>400 (Bad Request): XPath expression not provided or contains syntax errors.</li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                                <li>501 (Not Implemented): XPath API not supported.</li>
                            </ul>
                        </p>
                    </section>
                    <section id="search-semantic" class="normative">
                        <h4>Semantic search: SPARQL</h4>
                        The support for SPARQL Search API is optional.
                        <span class="rfc2119-assertion" id="tdd-search-sparql-version">
                            If implemented, the SPARQL search API MUST allow searching TDs using
                            the SPARQL protocol [[sparql11-overview]].
                        </span>
                        <span class="rfc2119-assertion" id="tdd-search-sparql-method-get">
                            The SPARQL API MUST accept queries using HTTP <code>GET</code> requests
                            at `/search/sparql?query={query}` endpoint, where `query` is the SPARQL expression.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-search-sparql-method-post">
                            The support for SPARQL search using HTTP <code>POST</code> method
                            at `/search/sparql` endpoint is OPTIONAL.
                        </span>
                        <code>UPDATE</code> queries are out of the scope for the API.
                        <span class="rfc2119-assertion" id="tdd-search-sparql-resp">
                            A successful response MUST have 200 (OK) status, and depending on the type
                            of query contain by default as Content-Type header <code>application/ld+json</code>
                            for <code>CONSTRUCT</code> and <code>DESCRIBE</code> queries or
                            <code>application/json</code> for <code>SELECT</code> or <code>ASK</code>.
                            The response body MAY contain TD fragments or a set of TDs depending on the query.
                        </span>
                        The semantic search with SPARQL is specified as `searchSPARQL` action in
                        [[[#directory-thing-description]]].
                        <p>List of errors:
                            <ul>
                                <li>400 (Bad Request): SPARQL query not provided or contains syntax errors.</li>
                                <li>401 (Unauthorized): No authentication.</li>
                                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                                <li>501 (Not Implemented): SPARQL API not supported.</li>
                            </ul>
                        </p>
                        <span class="rfc2119-assertion" id="tdd-search-sparql-federation">
                            A WoT Thing Description Directory MAY implement federation in its SPARQL query API.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-search-sparql-federation-imp">
                            If implemented, the SPARQL API MUST implement the
                            SPARQL 1.1 Federated Query standard [[sparql11-overview]].
                        </span>
                    </section>
                </section>
            </section>
            <section id="exploration-directory-security" class="normative">
                <h3>Security and Privacy</h3>
                <p class="ednote" title="Security Considerations Overview">
                    Minimum security and privacy requirements for confidentiality, authentication, access control, etc.
                </p>
            </section>
        </section>
    </section>

    <section id="security-considerations" class="informative">
        <h1>Security and Privacy Considerations</h1>
        <p>
            Security and privacy are cross-cutting issues that need to be considered
            in all WoT building blocks and WoT implementations. This chapter
            summarizes some general issues and guidelines to help
            preserve the security and privacy of concrete WoT discovery implementations.
            For a more detailed and complete analysis of security and
            privacy issues, see the <em>WoT Security and Privacy Guidelines</em>
            specification [[?WOT-SECURITY]].
        </p>
        <p>
            The WoT discovery architecture is designed to avoid a dependence on the security
            and privacy of existing discovery schemes by using a two-phase approach and
            requiring authorization before metadata release.  However several security and
            privacy risks still exist.  These are listed below along with possible mitigations.
            The level of risk to privacy in particular depends on the use case and whether
            there is a risk that information related to a person might be distributed in
            a fashion inconsistent with the privacy desires of that person. 
            We distinguish the following broad classes of use case scenarios:
        </p>
        <dl>
            <dt>Institutional</dt>
            <dd>Both the Things producing metadata and 
            the Consumers of that metadata are owned and controlled by an institution or 
            representatives of an institution.  Example: Automation in a factory where
            a control system is accessing the state of an assembly line in order to
            evaluate quality.
            </dd>
            <dt>Service</dt><dd>The Things producing metadata  
            are owned and controlled by an institution or representatives of an institution
            while the consumers are individuals.  Example: driver of an electric vehicle 
            accessing the TD for a charge station in order to check status of a charge.
            </dd>
            <dt>Personal</dt><dd>Both the Things producing metadata and 
            the Consumers of that metadata are owned and controlled by the same individual.
            Example: A smart home control system for charging an electric car from
            home-attached solar panels, both home and car owned by the same person.
            </dd>
            <dt>Personal Peer-to-Peer</dt><dd>The Things producing metadata and 
            the Consumers of that metadata are owned and controlled by different individuals.
            Example: A smart home control system for charging a guest's electric car from
            home-attached solar panels.
            </dd>
            <dt>Institutional Peer-to-Peer</dt><dd>The Things producing metadata and 
            the Consumers of that metadata are owned and controlled by different institutions.
            Example: A utility provides and manages power delivered to a factory, and
            the factory provides an interface for the utility to negotiate on-demand power
            usage reductions.
            </dd>
            <dt>Client</dt><dd>The Things producing metadata  
            are owned and controlled by an individual
            while the consumers are an institution or representatives of an institution.
            Example: A personal electric vehicle exposes an interface to a public charging station 
            so that the charging station can evaluate the charge status of the vehicle.
            </dd>
        </dl>
        <p>
            All of these in fact carry privacy risks.  Even in the case of factory
            automation, there is the chance that data about employee performance would
            be captured and would have to be managed appropriately.
        </p>
        <p>
            With these categories established, we will now discuss some specific
            risks and potential mitigations.
        </p>
        <section id="security-consideration-ddos">
            <h2>Denial of Service</h2>
            <p>
                Certain functions of the directory service,
                in particular search queries,
                may require significant resources to execute and this fact
                can be used to launch DDoS attacks against
            WoT Thing Description Directory services.
            </p>
            <p>
                This is mostly of concern in the Service scenario, where the 
                metadata requester is a private individual and the provider is an institution.
                In some cases this risk may appear in Peer-to-Peer scenarios as well.
                <dl>
                    <dt>Mitigations:</dt><dd>
                    A WoT Thing Description Directory implementation should 
                    <ul>
                    <li>Limit the number of queries per unit time from the same requestor</li>
                    <li>Limit the complexity of queries (for example, the total length of the query 
                    expression or its depth)</li>
                    <li>Use a watchdog timer to abort queries that take more than
                a certain maximum (implementation-configurable) amount of time.</li> 
                    </ul>
                    In cases where queries are refused or aborted 
                    appropriate error responses should be returned.
                    </dd>
                </dl>
            </p>
        </section>
<!-- Notes from issue https://github.com/w3c/wot-security/issues/196
* Sensitivity of geolocation information (when we have it) for privacy when device is associated with a person, 
i.e. location of a personal vehicle. This also includes inferred location, e.g. directory estimates location of device based on wifi range.
* Sensitivity of directory metadata, e.g. last update (watch, periodic TD updates, time of last update can be used to infer if someone is home...).  Note: similar to DHCP metadata risk.
* Sensitivity of thing ids (again, when device is associated with a person)
* Query injection (SPARQL and javascript fragments in JSON path) allowing execution of arbitrary code on the server
    - SPARQL is language-sandboxed but DDoS is possible
    - JSONpath needs to have its power limited, e.g. should not allow arbitrary embedded JS but 
      instead only specific expressions, e.g. string and numeric comparison; 
      regex's are a challenge, we need to look at specific features of regexes, e.g. embedded script execution. 
      A JSON path standard that already deals with this would be useful, but... 
    - To do: look at Xpath spec to see if these issues are dealt with. 
      One path here is to only allow features in JSON Path that are equivalent to some feature in Xpath, 
      assuming Xpath has already had its power suitably limited
    - Not actually a risk; it's something we should design out!
* Access control for directories; 
  directories have authentication, maybe some information is limited to certain categories of users; 
  should the standard specify an admin interface to control this?
* Should "nosec" be allowed as a security scheme in some circumstances?
* Good access control can mitigate some of the other risks.
* Location may be implicit. 
  If a TD simply appears in a directory, 
  then we know the Thing is in range (e.g. of WiFi) so it can register with the TDD
* Sensitivity of client IDs associated with some security schemes. 
  These may be harder to rotate than Thing IDs. 
  Mitigation: hide IDs by treating them as private information (see "uri" examples)
* Mitigations for a lot of these are mitigated by access control. However...
  This still allows tracking by "authorized" parties, 
  which if you don't own the hardware could be anyone 
  (e.g. the police, a random guy in the IT department of the traffic department, etc). Options:
     * Turn off registration; this however just disables discovery
     * Encrypt the TD; makes search, validation, etc. impossible
       Also still requires some way to identify the TD, which could then be used for tracking by a third party.
     * Move location information to a property of the Thing and don't store in the directory. 
       This however would disable geospatial discovery
  In general, "disabling" geolocation for personal devices may be necessary, 
  although it still is useful for institutional use cases
* Another option would be to use a "code generator" to generate IDs (perhaps in combination with encrypted TDs) 
  that is synchronized between the device and another application available to the user. 
  So, for example, a user could use an app on their laptop to generate the current ID 
  and then do a discovery search to find the location of their car, 
  which had registered an encrypted TD with that (rotating) ID with a discovery service.
* We should study how/if there are any solutions for this in phones, etc.
* Probably we need to allow "nosec" although it's probably a very bad idea except for development use cases. 
     * We could perhaps add an assertion that 
       "If a TDD service is available to anyone other than the developer and supports 
       registration of third-party TDs then it MUST NOT use the "nosec" scheme."
     * Some non-nosec options are still insecure so perhaps we should be more specific about good options. 
       We could just refer to the "security best practices" and say 
       "one of the recommended best-practice security schemes should be used"
     * Encrypted TDs would not be able to support many features of discovery, 
       including queries (except for retrieving TDs by ID), validation
     * We would also have to disable notifications in the directory because when an ID is updated, 
       we want to delete the old TD and create a new one with a new TD. 
       Sending notifications of an update would defeat the purpose.
     * A tracker could still watch for deletions followed immediately by creations and "guess" 
       that this is an update (and update their tracker to the new ID). 
     * The tracker would have to be the owner of the directory in this case. 
     * This however, by itself, just allows the persistent presence of a device to be inferred. 
     * However, it might be possible to combine this with other information eg. from DHCP logs 
       (granting IPs to a new device with a known MAC), proxy logs, 
       IP address of registration request to the directory. 
     * Similar risk with phones (MAC address), similar mitigations (e.g. rotate MAC address).
* Need to clarify use cases
     * Institutional (factory, smart city) - publishing public services
     * Private (personal use) - services that you want available from remote locations (e.g. access car in parking garage charging station from cafe, e.g. to check status of charge)
* Alternative to encrypted TDs: Private Directories.
     * Register personal devices only to directories that only you have access rights to, 
       e.g. hosted in your personal home gateway

Note: not all of the above risks belong in this section.  In particular, if a risk can be designed out
(e.g. making it impossible to do query injection) then we should do so.  Access controls should also
be discussed elsewhere and perhaps mentioned as tools for addressing the following. 
-->
        <section id="security-consideration-location-tracking">
            <h2>Location Tracking</h2>
            <p>
                A discovery service may potentially allow the approximate location of a person to be determined without
                their consent.  This risk occurs in some specific circumstances which can be avoided or
                mitigated.  It is also similar to the risk posed by other network services such as DHCP and DNS.
            </p>
            <p>
                For this risk to occur, there first has to be an IoT device that can be reliably associated
                with a person's location, such as a necessary medical device or a vehicle.  
                Note that the risk only applies to personal use cases, not institutional ones.
                Secondly, the
                device has to be configured to register automatically with the nearest directory service.
                In this case, the location of the device can be inferred from the network range of the directory
                service and the location of the person inferred from the location of the device.
            </p>
            <p>
                There are a few variants of this: 
                <ul>
                <li>The TD or Thing could report actual location information so no inferencing by network range is needed;</li>
                <li>A directory could support actual search by location;</li>
                <li>Absence of a TD in a directory could reveal negative location information (e.g. if a TD
                    times out and is removed from a directory, that means the device has not been present for
                    a while, which could be used to infer that a person is NOT in a particular location, e.g. not at
                    home.</li>
                </ul>
                </p>
            <p>
                Some of these risks are shared by similar services.  For example, DCHP automatically responds to 
                requests for IP addresses on a local network, and devices typically provide an identifier (a MAC
                address) as part of this process, and the DHCP server maintains a registry. In theory, someone with
                access to the DHCP server in, say, a cafe, could use this information to track someone's phone and
                infer their location.
            </p>
            <dl>
                <dt>Mitigations:</dt>
                <dd>
                There are a few options to mitigate this risk:
                <ul>
                <li>Disable registration with public directories.  Registration would still be possible with 
                personal directories, for example, a home gateway, but a user could disable registration at other
                locations.  This has the disadvantage that functionality is lost: personal devices cannot be
                discovered in public locations.  This could be addressed by having internet-accessible private
                discovery services (e.g. the home gateway could provide an internet-accessible service, but with
                access control limiting use to authorized users.</li>
                <li>Rotate IDs.  Using fixed IDs makes it exceptionally easy to track devices.  This problem
                also occurs in DHCP with MAC address and there is a similar partial mitigation: 
                generate new random IDs periodically.
                There are however, a few issues.  First of all, other identification information in the TD needs to be 
                hidden.  For example, client IDs issued by CSPs for API security should be omitted from TDs if 
                they cannot be easily rotated.  Second, if the device rotates the ID, the user may still need to 
                know the current ID to find the device via discovery.  This can be accomplished however by generating new
                IDs using a deterministic cryptographic generator that is a function of the current time.
                However, note that rotating IDs alone does not make tracking impossible since a TD might be fingerprinted.
                Also, updating an ID might be observable to the owner of the directory service, who could track
                and record the updated ID.  Even if the TD is deleted and reinserted the association could be 
                inferred.  This is however exactly parallel to the situation with DHCP and rotation of MAC addresses.
                In general, however, generating new IDs at least for each service or person to which a TD is supplied
                makes it harder to connect registration events at different locations and times.
                </li>
                <li>The problem of negative location inferencing can be mitigated by limiting access to 
                private directories, for example in the home, by using access controls.  If an attacker cannot access the service,
                they cannot retrieve information to infer location.  Access rights provided to guests (Peer-to-Peer Personal)
                should be appropriately time-limited.
                Use of long time-to-live values may be appropriate in other cases.  In addition, TDs should be updated in a 
                directory only when they change.  For example, the TD for a car may only be updated when new car firmware is available
                providing new services, and the time-to-live might be set at one month (covering most absences).
                </li>
                <li>When explicit location information is available, whether stored in a TD or available in a property,
                additional care should be taken to only share the TD and/or access to the device with trusted partners,
                including directories.  If the TD must be shared with a public directory, the location information can be 
                stripped.
                </ul>
                </dd>
            </dl>
        </section>
    </section>

    <section id="directory-api-spec">
        <h1>Directory Service API Specifications</h1>
        <section id="directory-thing-description">
            <h3>Directory API Thing Description</h3>
            <p>Below is a generic Thing Description for the Directory API
                with OAuth2 security. This specification only covers the HTTP and SSE
                protocol bindings. Other protocol bindings may be specified in future.
                
                The Thing Description alone should not be
                considered as the reference to implement or interact with
                a directory. The full specification is available as human-readable text 
                in [[[#exploration-directory-api]]].
            </p>

            <pre class="advisement json">
                <div data-include='directory.td.json'></div>
            </pre>

            <p class="ednote" title="Scopes">
                The scopes may need to be more concrete to able to allow updates but prevent creation.
            </p>
            <p class="issue" data-number="82">
                Need to confirm if equivalent OpenAPI spec can be easily created out of the TD in
                [[[#directory-thing-description]]]. If yes, a sentence may be added indicating
                this possibility.
            </p>
            <p class="ednote" title="Context URIs">
		The context URIs are tentative and subject to change. 
	    </p>
            <p class="issue" data-number="86"></p>         
        </section>
    </section>

    <section id="iana-considerations" class="normative">
        <h1>IANA Considerations</h1>
        <section id="well-known-uri-suffix">
            <h2>Well-Known URI Registration</h2>
            <p>
                IANA will be asked to allocate the following value into the Well-Known URI
                defined in [[RFC8615]].
            </p>
            <ul>
                <li>URI suffix: <code>wot-thing-description</code></li>
            </ul>
            <p class="ednote" title="Shorter suffix">
                We are currently discussing whether we should adopt a shorter URI suffix (such as <code>wot-td</code>)
                in view of limited packet lengths for some protocols.
            </p>
        </section>
        <section id="service-name">
            <h2>Service Name Registration</h2>
            <p>
                IANA will be asked to allocate the following value into Service Name and Transport Protocol Port Number Registry
                defined in [[RFC6335]].
            </p>
            <ul>
                <li>Service Name: <code>wot</code></li>
                <li>Transport Protocol: TCP, UDP</li>
                <li>Description: Service name to search a Thing or a Thing Description Directory of W3C Web of Things</li>
                <li>Port Number: N/A</li>
                <li>Assignment notes: PTR, SRV, TXT RR types are used</li>
            </ul>
        </section>
        <section id="core-resource-type">
            <h2>CoRE Resource Types Registration</h2>
            <p>
                IANA will be asked to allocate the following values into the Resource Type (<code>rt=</code>)
                Link Target Attribute Values sub-registry of the Constrained Restful Environments (CoRE)
                Parameters registry defined in [[RFC6690]].
            </p>
            <table>
                <thead>
                    <tr>
                        <th>Value</th>
                        <th>Description</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>wot.thing</code></td>
                        <td>Thing Description of a Thing</td>
                        <td>[[[#introduction-core-rd]]]</td>
                    </tr>
                    <tr>
                        <td><code>wot.directory</code></td>
                        <td>Directory Description of a <a>Thing Description Directory</a></td>
                        <td>[[[#introduction-core-rd]]]</td>
                    </tr>
                </tbody>
            </table>

        </section>
    </section>
    
    <section id="changes" class="appendix">
      <h1>Recent Specification Changes</h1>
      <h2 id="changes-from-first-draft">Changes from First Draft</h2>
      <ul>
      <li>Update name of directory service to "Thing Description Directory" with acronym TDD, 
      to avoid confusion with the acronym TD used for Thing Descriptions.
      </li>
      <li>Elaboration of complete API for registration of a Thing Description with a 
      Thing Description Directory, 
      including support for creation, update, retrieval, deletion, and listing.
      </li>
      <li>Add recommendation that TDs be validated before storage in a directory.
      Note: this corresponds to work under way in the TD spec to precisely define
      appropriate levels of automatic validation for different contexts, including
      directory registration.
      </li>
      <li>Addition of Security and Privacy Considerations 
      regarding Denial of Service and Location Tracking.
      </li>
      <li>Addition of IANA Considerations regarding CoRE Resource Types.
      </li>
      <li>Definition of Enriched TD to support embedded metadata in TDs returned by a TDD.
      </li>
      <li>Updates to description of exploration to avoid unnecessary dependence 
      on HTTP (in the future, other protocols may be supported).
      </li>
      <li>Use of "resource type" instead of "endpoint type" when describing entry in CoRE RD.
      </li>
      <li>Addition of ontology for TDDs that include the type <code>DirectoryDescription</code>
      identifying TDs of directories and 
      a type <code>LinkDescription</code> to identify a TD that is just a link to another 
      TD (useful for referring to remote directories in order to support federation).
      </li>
      <li>Add section for self-description exploration mechanism. 
      This supports the use case where a Thing hosts its own TD and peer-to-peer Thing
      communication.
      </li>
      <li>Addition of diagram showing the directory information model.
      </li>
      <li>Removal of reference to Issue 16, citing CRUD interface requirements.
      Replaced with CRUDL (CRUD + Listing) interface requirement.
      </li>
      <li>MAY assertion added to explicitly permit implementation of SPARQL federation, 
      and a requirement that if implemented, it needs to follow the SPARQL 1.1 specification.
      </li>
      <li>Updates to references: more recent versions of CoRE RD, DID Core, Eventsource, JSON-LD, 
      and JSON Path specifications. 
      Use of datatracker service (and URLs) to reference IETF RFCs. 
      Addition of normative references to RFC7396 and RFC7540.
      </li>
      </ul>
    </section>

    <section id="acknowledgements" class="appendix normative">
        <h1>Acknowledgments</h1>
<!--
        <p>Special thanks to X, Y, and Z
           for their contributions to this document.
        </p>
-->
        <p>
            Many thanks to the W3C staff and all other active Participants of the W3C Web
            of Things Interest Group (WoT IG) and Working Group (WoT WG) for their
            support, technical input and suggestions that led to improvements to
            this document.
        </p>
    </section>
</body>
</html>
