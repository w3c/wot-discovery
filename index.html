<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8" />
<title>Web of Things (WoT) Discovery</title>
<script 
    src="https://www.w3.org/Tools/respec/respec-w3c"
    class="remove"
    defer
></script>
<script class="remove">
        var respecConfig = {
        lint: {
            "check-punctuation": true,
            "local-refs-exist": true,
            "no-http-props": true,
            "no-headingless-sections": true
        },
        doJsonLd : true,
        specStatus : "ED",
        shortName : "wot-discovery",
        copyrightStart : 2017,
        group: "wg/wot",
        wgPublicList : "public-wot-wg",
        github: {
            repoURL: "https://github.com/w3c/wot-discovery",
            branch: "master"
        },
        // previousPublishDate: "2019-05-16",
        // previousMaturity: "CR",
        editors : [ {
            name : "Andrea Cimmino",
            w3cid : "115672",
            company : "Universidad Politécnica de Madrid",
            companyURL : "https://www.upm.es/"
        }, {
            name : "Michael McCool",
            w3cid : "93137",
            company : "Intel Corp.",
            companyURL : "https://www.intel.com/"
        }, {
            name : "Farshid Tavakolizadeh",
            w3cid : "122520",
            company : "Fraunhofer-Gesellschaft",
            companyURL : "https://www.fraunhofer.de/"
        }, {
            name : "Kunihiko Toumura",
            w3cid : "83488",
            company : "Hitachi, Ltd.",
            companyURL : "https://www.hitachi.com/"
        } ],
        otherLinks : [
                {
                    key : "Contributors",
                    data : [ {
                        value : "In the GitHub repository",
                        href : "https://github.com/w3c/wot-discovery/graphs/contributors"
                    } ]
                }],
        localBiblio : {
            "REST-IOT" : {
                  title: "RESTful Design for Internet of Things Systems"
                , href: "https://tools.ietf.org/html/draft-irtf-t2trg-rest-iot-06"
                , authors:  [
                    "Ari Keranen"
                  , "Matthias Kovatsch"
                  , "Klaus Hartke"
                  ]
                , publisher: "IETF"
                , date: "11 May 2020"
            },
            "CoRE-RD" : {
                  title: "CoRE Resource Directory"
                , href: "https://tools.ietf.org/html/draft-ietf-core-resource-directory-25"
                , authors: [
                    "Zach Shelby"
                  , "Michael Koster"
                  , "Carsten Bormann"
                  , "Peter van der Stok"
                  , "Christian Amsüss"
                  ]
                , publisher: "IETF"
                , date: "13 July 2020"
            },
            "JSONPATH" : {
                  title: "JSONPath -- XPath for JSON"
                , href: "https://tools.ietf.org/id/draft-goessner-dispatch-jsonpath-00.html"
                , authors: [
                    "S. Gössner"
                  , "C. Bormann, Ed."
                  ]
                , publisher: "IETF"
                , date: "12 July 2020"
                , status: "DRAFT",
            },
            "wot-usecases" : {
                  title: "Web of Things (WoT): Use Cases"
                , href: "https://w3c.github.io/wot-usecases/"
                , authors: [
                    "Michael Lagally"
                  , "Michael McCool"
                  , "Ryuichi Matsukura"
                  , "Tomoaki Mizushima"
                  ]
                , publisher: "W3C"
                , date: "15 October 2020"
                , status: "Editor's Draft",
            }
        }
    };
</script>
<style type="text/css">
a[href].internalDFN {
        color: inherit;
        border-bottom: 1px solid #99c;
        text-decoration: none;
}
img.wot-diagram {
    max-width: 90%;
    height: auto;
}
.rfc2119-assertion {
  background-color: rgb(230,230,230)
}
</style>
</head>
<body>
    <section id="abstract">
        <p>The W3C Web of Things (WoT) is intended to enable
           interoperability across IoT platforms and application
           domains.  One key mechanism for accomplishing this goal
           is the definition and use of metadata describing the
           interactions an IoT device or service makes available
           over the network at a suitable level of abstraction.  
           The WoT Thing Description specification satisfies this objective.
        </p>
        <p>However, in order to use a Thing its Thing Description
           first has to be obtained.  The <em>WoT Discovery</em> process described 
           in this document addresses this problem.
           WoT Discovery needs to support the distribution of WoT Thing Descriptions
           in a variety of use cases.  This includes ad-hoc and engineered systems;
           during development and at runtime; and on both local and global networks.
           The process also needs to work with existing discovery mechanisms,
           be secure, protect private information, and be able to efficiently
           handle updates to WoT Thing Descriptions and the 
           dynamic and diverse nature of the IoT ecosystem.
        </p>
        <p>The WoT Discovery process is divided into two phases,
           Introduction, and Exploration.  The Introduction phase 
           leverages existing discovery mechanisms but does not directly
           expose metadata; they are simply used to discover Exploration
           services, which provide metadata but only after secure authentication
           and authorization.  This document normatively defines two Exploration
           services, one for WoT Thing self-description with a single 
           WoT Thing Description and a searchable WoT Thing Directory
           service for collections of Thing Descriptions.
           A variety of Introduction services are also described and where
           necessary normative definitions are given to support them.
        </p>
    </section>
    <!-- The following will be filled in by ReSpec -->
    <section id="sotd"></section>
    <section id="introduction">
        <h1>Introduction</h1>
        <p>The Web of Things (WoT) defines an architecture that supports the integration
           and use of web technologies with IoT devices.
           The WoT Architecture [[wot-architecture]] document defines the basic
           concepts and patterns of usage supported.
           However, the WoT Thing Description [[wot-thing-description]] is a key
           specification for WoT Discovery since it is the purpose of WoT Discovery
           to make WoT Thing Descriptions available.
           Specifically, WoT Discovery has to allow authenticated and authorized entities
           (and only those entities) to find WoT Thing Descriptions satisfying a set of
           criteria, such as being near a certain location, or having certain semantics,
           or containing certain interactions.  Conversely, in order to support
           security and privacy objectives, the WoT Discovery process must not
           leak information to unauthorized entities.  This includes leaking information
           that a given entity is requesting certain information, not just the information
           distributed in the Thing Descriptions themselves.
	</p>
        <p>There are already a number of discovery mechanisms defined, so we have to 
           establish why we are proposing a new one.  First, many existing 
           discovery mechanisms have relatively weak security and privacy protections.
           One of our objectives is to establish a mechanism that not only uses best
           practices to protect metadata, but that can be upgraded to support future
           best practices as needed.
           Second, we are using discovery in a broad sense to include both local and
           non-local mechanisms.  While a local mechanism might use a broadcast protocol,
           non-local mechanisms might go beyond the current network segment where broadcast
           is not scalable, and so a different approach, such as a search service, is needed. 
           Our approach is to use existing mechanisms as needed to bootstrap into a more 
           general and secure metadata distribution system.
           Third, the metadata we are distributing, the WoT Thing Description, is highly
           structured and includes rich data such as data schemas and semantic annotations.
           Existing discovery mechanisms based on a list of simple key-value pairs are 
           not appropriate.  
           At the same time, 
           use of existing standards for semantic data query, 
           such as SPARQL [[SPARQL11-OVERVIEW]], 
           while potentially suitable for some advanced use cases, 
           might require to much effort for many anticipated IoT applications.
           Therefore in order to address more basic applications,
           we also define some simpler query mechanisms. 
        </p>
        <p>After defining some basic terminology, we will summarize the basic use cases and
           requirements for WoT Discovery.  These are a subset of the more detailed and
           exhaustive use cases and requirements presented in the WoT Use Cases [[wot-usecases]] and 
           WoT Architecture [[wot-architecture]] documents.
           Then we will describe the basic architecture of the WoT Discovery process,
           which uses a two-phase Introduction/Exploration approach.  The basic goal of this
           architecture is to be able to use existing discovery standards to bootstrap
           access to protected discovery services, but to distribute detailed metadata only to 
           authorized users, and to also protect those making queries from eavesdroppers 
           as much as possible.
           We then describe details of specific Introduction and Exploration mechanisms.
           In particular, we define in detail a normative API for a 
           WoT Thing Description Directory (WoT TDD) service that provides a search mechanism for
           collections of WoT Thing Descriptions that can be dynamically registered by Things or
           entities acting on their behalf.  The WoT Discovery mechanism however also supports
           self-description by individual Things and one issue we address is how to distinguish
           between these two approaches.
           Finally, we discuss some security and privacy considerations, including a set of 
           potential risks and mitigations.
        </p>
    </section>
    <!-- The following will be filled in by ReSpec -->
    <section id="conformance"></section>
    <section id="terminology" class="informative">
        <h1>Terminology</h1>
        <p>The present document uses the terminology defined in
           the WoT Architecture [[wot-architecture]] document,
           and also the additional terms defined here.
           The WoT prefix is used to avoid ambiguity for terms that are
           (re)defined specifically for Web of Things concepts.</p>
        <dl>
            <dt><dfn data-lt="WoT Anonymous Thing Description">Anonymous TD</dfn>
            </dt>
            <dd>A Thing Description without an identifier (`id` attribute).
            </dd>
            <dt><dfn data-lt="WoT Discovery">Discovery</dfn>
            </dt>
            <dd>In the WoT context, the process of finding and retrieving Thing metadata
            in the form of Thing Descriptions for Things satisfying some criteria of interest.
            </dd>
            <dt><dfn data-lt="WoT Exploration">Exploration</dfn>
            </dt>
            <dd>A discovery mechanism that provides access to detailed metadata in the 
            form of one or more Thing Descriptions.  Exploration mechanisms are in
            general protected by security mechansism and are accessible only to authorized users.
            </dd>
            <dt><dfn data-lt="WoT Introduction">Introduction</dfn>
            </dt>
            <dd>A "first contact" discovery mechanism, whose result is a URL that
            references an exploration mechanism.  Introduction mechanisms themselves
            should not directly provide metadata, and in general are designed to be 
            open.
            </dd>
            <dt><dfn data-lt="WoT Thing Description Directory">Thing Description Directory (TDD)</dfn>
            </dt>
            <dd>A directory service with a prescribed API that allows the 
            registration, management, and search of a database of Thing Descriptions.
            Note that the acronym should be TDD, not TD, to avoid confusion with Thing Descriptions (TDs).
            </dd>
            <dt><dfn data-lt="WoT Partial Thing Description">Partial TD</dfn>
            </dt>
            <dd>A data model partially conformant to the Thing Description schema by including 
            only a subset of the attributes.
            </dd>
        </dl>
    </section>
    <section id="architecture" class="informative">
        <h1>Architecture</h1>
        <a href="#discovery-overview"></a> shows an overview of discovery process.
        <figure id="discovery-overview">
            <img src="images/overview.png"
                srcset="images/overview.svg"
                class="wot-diagram"
                alt="Discovery process overview" />
            <figcaption>Discovery process overview</figcaption>
        </figure>
        <p class="ednote" title="Discovery Architecture Overview">
        To do: an overview of the two-phase approach and its purpose, which is to support
        controlled and authenticated access to metadata by authorized users only.
        </p>
    </section>
    <section id="introduction-mech" class="normative">
        <h1>Introduction Mechanisms</h1>
        <p>This chapter describes a mechanism for discovering a Thing or a Directory Service.
           The following mechanism is provided by the Thing or the Directory Service so that
           Consumer can discover the Thing Description or a URL that point to the Thing Description.
        </p>
        <section id="introduction-direct" class="normative">
            <h2>Direct</h2>
            <p>Any mechanism that results in a single URL.
               This includes Bluetooth beacons, QR codes, and written URLs to be 
               typed by a user.
               A GET on all such URLs MUST result in a TD.
               For self-describing Things, this can be the TD of the Thing itself.
               If the URL references a Directory, this MUST be the TD of the
               Directory service.
            </p>
        </section>
        <section id="introduction-well-known" class="normative">
            <h2>Well-Known URIs</h2>
            <p>
                A Thing or Directory Service MAY use the Well-Known Uniform Resource Identifier [[RFC8615]]
                to advertise its presence.  The Thing or Directory Service registers its own Thing Description
                into the following path:
                <code>/.well-known/wot-thing-description</code>.
            <p>
                When the HTTP GET access is made to the above path, the HTTP server MUST return
                a Thing Description with the <code>content-type</code> set to <code>application/td+json</code>.
            </p>
            <p class="ednote" title="Registration of Well-known URI">
                The service name in Well-Known URI (<code>wot-thing-description</code>) is tentative.
                "Well-Known URIs" registry and contents of registration request is described in Section 3.1 of [[RFC8615]].
            </p>

        </section>
        <section id="introduction-dns-sd" class="normative">
            <h2>DNS-Based Service Discovery</h2>
            <p>A Thing or Directory Service MAY use the DNS-Based Service Discovery (DNS-SD)[[RFC6763]].
                This can be also be used to discover them on the same link by combining Multicast DNS (mDNS)[[RFC6762]].
            </p>
            <p>
                In DNS-SD, format of the Service Instance Name is <code>Instance.Service.Domain</code>. 
                The Service part is a pair of labels following the conventions of [[RFC2782]].
                The first label has an underscore followed by the Service Name,
                and the second label describes the protocol.
            </p>
            <p>
                The Service Name to indicate the Thing or Directory Service MUST be <code>_wot</code>.
                And the Service Name to indicate the Directory Service MUST be <code>_directory._sub._wot</code>.
            </p>
            <p class="ednote" title="Service Names in existing implementations">
                The Service Names <code>_wot</code> and <code>_directory._sub._wot</code>
                are tentative. The following Service Names are used in the existing implementations:
                <code>_wot</code>,
                <code>_device._sub._wot</code>,
                <code>_directory._sub._wot</code>,
                <code>_webthing</code>.
                To use a Service Name, registration to "Underscored and Globally Scoped DNS Node Names"
                Registry [[RFC8552]] is required.
            </p>
            <p>
                In addition, the following information MUST be included in the <code>TXT</code>
                record that is pointed to by the Service Instance Name:
                <dl>
                    <dt><code>td</code></dt>
                    <dd>Absolute pathname of the Thing Description of the Thing or Directory Service.</dd>
                    <dt><code>type</code></dt>
                    <dd>Type of the Thing Description, i.e. <code>Thing</code> or <code>Directory</code>.
                    If omitted, the type is assumed to be <code>Thing</code>.</dd>
                </dl>
            </p>
            <p class="ednote" title="Usage of a TXT record in existing implementations">
                The following key/value pairs are used in the existing implementations:<br/>
                <code>retrieve</code>:
                        Absolute path name of the API to get an array of Thing Description IDs
                        from the Directory Service.<br/>
                <code>register</code>:
                    Absolute path name of the API to register a Thing Description with the Directory Service.<br/>
                <code>path</code>:
                    The URI of the thing description on the Web Thing's web server<br/>
                <code>td</code>:
                    Prefix of Directory Service API<br/>
                <code>tls</code>:
                    Value of 1 if the Web Thing supports connections via HTTPS.<br/>
            </p>
            <p>
                <a href="#sequence-dnssd-thing"></a> and <a href="#sequence-dnssd-directory"></a> shows example sequences
                of discovery of Thing and Directory Service using DNS-SD and mDNS. 
            </p>
            <figure id="sequence-dnssd-thing">
                <img src="images/sequence-dnssd-thing.png"
                    srcset="images/sequence-dnssd-thing.svg"
                    class="wot-diagram"
                    alt="An example sequence of discovery of Thing using DNS-SD and mDNS" />
                <figcaption>An example sequence of discovery of Thing using DNS-SD and mDNS</figcaption>
            </figure>
            <figure id="sequence-dnssd-directory">
                <img src="images/sequence-dnssd-directory.png"
                    srcset="images/sequence-dnssd-directory.svg"
                    class="wot-diagram"
                    alt="An example sequence of discovery of Directory Service using DNS-SD and mDNS" />
                <figcaption>An example sequence of discovery of Directory Service using DNS-SD and mDNS</figcaption>
            </figure>

        </section>
        <section id="introduction-core-rd" class="normative">
            <h2>CoRE Link Format and CoRE Resource Directory</h2>
            <p>
                A Thing or Directory Service MAY advertise its presence using the
                Constrained RESTful Environment (CoRE) Link Format [[RFC6690]].
                And, a Thing or Directory Service MAY use the CoRE Resource Directory [[CoRE-RD]]
                to register a link to the Thing Description.
            </p>
            <p>
                The endpoint type(<code>et</code>) of the Link that targets the Thing Description of the Thing
                MUST be <code>wot.thing</code>. 
                The endpoint type of the Link that targets the Thing Description of the Directory Service
                MUST be <code>wot.directory</code>.
            </p>
            <p class="ednote">
                The endpoint types <code>wot.thing</code> and <code>wot.directory</code> are tentative.
            </p>
        </section>
        <section id="introduction-did" class="normative">
            <h2>DID Documents</h2>
            <p>A Thing or Directory Service MAY advertise its presence using 
                the Decentralized Identifier (DID) [[DID-CORE]].
            </p>
            <p>
                The DID Document obtained by resolving the DID of a Thing or Directory Service MUST
                contains a Service Endpoint which point to Thing Description of the Thing or Directory Service.
            </p>
            <aside class="example" title="A Example Service Endpoint in a DID Document">
                <pre>
                    {
                        "service": [{
                            "id": "did:example:wotdiscoveryexample#td",
                            "type": "WotThingDescription",
                            "serviceEndpoint":
                                "https://wot.example.com/.well-known/wot-thing-description"
                        }]
                    }
                </pre>
            </aside>
            <div class="issue" data-number="65"></div>
        </section>
    </section>
    <section id="exploration-mech" class="normative">
        <h1>Exploration Mechanisms</h1>
        <p class="ednote" title="Exploration Mechanism Overview">
        To do: Description of supported explorations, and requirements for 
        new exploration mechanisms.
        </p>
        <section id="exploration-self" class="normative">
            <h2>Self-description</h2>
            <p class="ednote" title="Self-Description Overview">
            To do: Describe mechanisms for devices to self-describe, hosting their own TDs.
            </p>
        </section>
        <section id="exploration-directory" class="normative">
            <h2>Directory</h2>
            <p class="ednote" title="Directory Overview">
            To do: Describe mechanisms for TDs to be hosted in a searchable directory service.
            </p>
            <p>
                A Directory can be distinguished from a Thing by the use of an
                <code>@type</code> including the semantic term <code>Directory</code>.
            </p>

            <section id="exploration-directory-info" class="normative">
                <h3>Information Model</h3>
                <p class="ednote" title="Directory Information Model">
                To Do: Formal definition of information contained in a directory and its organization.
                </p>
            </section>
            <section id="exploration-directory-api" class="normative">
                <h3>Directory Service API</h3>
                The Directory APIs must use secure protocols guaranteeing 
                <a href="https://www.w3.org/TR/wot-security/#dfn-system-user-data">System User Data</a> 
                authenticity and confidentiality (see [[?WOT-SECURITY]]).
                <span class="rfc2119-assertion" id="tdd-https"> 
                    The HTTP API MUST be exposed over HTTPS (HTTP Over TLS).
                </span>
                <p>
                    The HTTP API responses must use appropriate status codes described in 
                    this section for success and error responses.
                    <span class="rfc2119-assertion" id="tdd-http-errors"> 
                        The HTTP API MUST use the Problem Details [[RFC7807]] format to carry
                        error details in HTTP client error (4xx) and server error (5xx) responses.
                    </span>
                    This enables both machines and humans to know the high-level error class
                    and fine-grained details.

                    <p class="ednote" title="WoT-specific error types">
                        The Problem Details error `type` field is a URI reference which 
                        could used to map the occurred error to WoT-specific error class. 
                        There are few open issues raising the lack of WoT-specific error types:
                        <a href="https://github.com/w3c/wot-discovery/issues/44">wot-discovery#44</a>,
                        <a href="https://github.com/w3c/wot-thing-description/issues/303">wot-thing-description#303</a>,
                        <a href="https://github.com/w3c/wot-scripting-api/issues/200">wot-scripting-api#200</a>.
                        <br>
                        For now, `type` can be omitted which defaults to "about:blank", and `title`
                        should be set to HTTP status text.
                    </p>
                </p>
                
                <p>Below is a generic Thing Description for the Directory HTTP API
                    with OAuth2 security. The Thing Description alone should not be
                    considered as the full specification to implement or interact with
                    a directory. Additional details for every interaction are described
                    in human-readable form in the subsequent sections.
                </p>
                <aside class="example" id="directory-thing-description" title="Thing Description of the Directory">
                    <pre><div data-include='directory.td.json'></div></pre>

                    <p class="ednote" title="Normative JSON Block">
                        Need to add a css class for normative code blocks, instead of using the `example` class.
                    </p>
                    <p class="ednote" title="ID Type">
                        The `id` variable need to have a defined type for semantic association with TD's `id` attribute.
                    </p>
                    <p class="ednote" title="Scopes">
                        The scopes may need to be more concrete to able to allow updates but prevent creation.
                    </p>
                    
                </aside>
                <p class="issue" data-number="82">
                    Need to confirm if equivalent OpenAPI spec can be easily created out of the TD in
                    [[[#directory-thing-description]]]. If yes, a sentence may be added indicating
                    this possibility.
                </p>

                <section id="exploration-directory-api-registration" class="normative">
                    <h4>Registration</h4>
                    <p>
                        The Registration API is a RESTful HTTP API in accordance with the recommendations
                        defined in [[RFC7231]] and [[?REST-IOT]].
                        <span class="rfc2119-assertion" id="tdd-reg-default-representation">
                            The default serialization format for all request and response bodies MUST be
                            JSON, with JSON-LD 1.1 [[JSON-LD11]] syntax to support extensions and semantic
                            processing.
                        </span>
                        <span class="rfc2119-assertion" id="tdd-reg-additional-representation">
                            Directories MAY accept additional representations based on request's indicated
                            Content-Type or Content-Encoding, and provide additional representations through
                            server-driven content negotiation.
                        </span>
                    </p>
                    <p>
                        <span class="rfc2119-assertion" id="tdd-reg-operations">
                            The Registration API MUST provide create, retrieve, update, delete (CRUD) interfaces. 
                        </span>
                        <div class="issue" data-number="16">
                            The API needs to offer a mechanism to efficiently query all TDs.
                            The search API may offer the expected functionality by searching for everything
                            and adding protocol-specific pagination arguments. However, that is hardly RESTful.
                            We could instead extend the registration API to CRUDL, adding Listing operation.   
                        </div>
                        The operations are described below:
                    </p>

                    <dl>
                        <dt>TD Creation</dt><dd>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-create-body">
                                The API MUST allow registration of a TD object passed as request body.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-create-contenttype">
                                The request SHOULD contain `application/td+json` Content-Type header for 
                                JSON serialization of TD.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-create-validation">
                                The TD object SHOULD be validated syntactically using the 
                                <a href="https://www.w3.org/TR/wot-thing-description/#json-schema-for-validation">Thing Description JSON Schema</a>
                                [[WoT-Thing-Description]]. <!-- any way to add anchor to citations? -->
                            </span>
                        </p>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-types"> 
                                A TD which is identified with an `id` attribute MUST be handled 
                                differently with one that has no identifier (<a>Anonymous TD</a>).
                            </span>
                            The create operations are specified as `createTD` action in 
                            [[[#directory-thing-description]]]
                            and elaborated below:
                        </p>
                        <ul>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-create-known-td">
                                    A TD MUST be submitted to the directory using an HTTP `PUT` request at a  
                                    target location (HTTP path) containing the unique TD `id`.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-create-known-td-resp">  
                                    Upon successful processing, the server MUST respond with
                                    201 (Created) status.                           
                                </span>

                                <p>
                                    Note: If the target location corresponds to an existing TD,
                                    the request shall instead proceed as an Update operation and respond
                                    the appropriate status code (see Update section).
                                </p>
                            </li>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-create-anonymous-td">
                                    An <a>Anonymous TD</a> MUST be submitted to the directory using an HTTP `POST` request. 
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-create-anonymous-td-resp">
                                    Upon successful processing, the server MUST respond with 201 (Created) status
                                    and a Location header containing a system-generated identifier for the TD.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-create-anonymous-td-generated-id"></span>
                                    The identifier SHOULD be a Version 4 UUID URN [[RFC4122]].
                                </span>
                            </li>
                        </ul>

                        <p>
                            Error responses:
                            <ul>
                                <li>
                                    400 (Bad Request): Invalid serialization or TD.
                                    This is accompanied by an appropriate response message.
                                </li>
                                <li>
                                    401 (Unauthorized): No authentication.
                                </li>
                                <li>
                                    403 (Forbidden): Insufficient rights to the resource.
                                </li>
                            </ul>
                        </p>
                      
                        <p class="ednote" title="Deduplication">
                            The server should employ a mechanism to eliminate duplication of TDs submitted with
                            a `POST` request. The spec need to have recommendations on how to perform this.
                        </p>
                        </dd>
                    
                        <dt>TD Retrieval</dt><dd>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-retrieve">
                                A TD MUST be retrieved from the directory using an HTTP `GET` request,
                                including the identifier of the TD as part of the path.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-retrieve-resp">
                                A successful response MUST have 200 (OK) status, contain `application/td+json`
                                Content-Type header, and the requested TD in body.
                            </span>
                            The retrieve operation is specified as `retrieveTD` property in 
                            [[[#directory-thing-description]]].
                        </p>

                        <p>
                            Error responses:  
                            <ul>
                                <li>
                                    404 (Not Found): TD with the given `id` not found.
                                </li>
                                <li>
                                    401 (Unauthorized): No authentication.
                                </li>
                                <li>
                                    403 (Forbidden): Insufficient rights to the resource.
                                </li>
                            </ul>
                        </p>
                        </dd>
                    
                        <dt>TD Update</dt><dd>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-update-types">
                                The API MUST allow modifications to an existing TD as full replacement or partial updates.
                            </span>
                            The update operations are described below:
                        </p>

                        <ul>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-update">
                                    A modified TD MUST replace an existing one when submitted using an HTTP `PUT` request
                                    to the location corresponding to the existing TD.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-contenttype">
                                    The request SHOULD contain `application/td+json` Content-Type header for JSON
                                    serialization of TD.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-validation">
                                    The TD object SHOULD be
                                    validated syntactically using the 
                                    <a href="https://www.w3.org/TR/wot-thing-description/#json-schema-for-validation">Thing Description JSON Schema</a>
                                    [[WoT-Thing-Description]]. <!-- any way to add anchor to citations? -->
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-resp">
                                    Upon success, the server MUST respond with 204 (No Content) status. 
                                </span>
                                This operation is specified as `updateTD` property in 
                                [[[#directory-thing-description]]].

                                <p>
                                    Note: If the target location does not correspond to an existing TD,
                                    the request shall instead proceed as a Create operation and respond
                                    the appropriate status code (see Create section). In other words, an HTTP `PUT`
                                    request acts as a create or update operation.
                                </p>
                            </li>
                            <li>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial">
                                    An existing TD MUST be partially modified when the modified parts are submitted using an 
                                    HTTP `PATCH` request to the location corresponding to the existing TD.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-mergepatch">
                                    The partial update MUST be processed using the JSON merge patch format 
                                    format described in [[RFC7396]].
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-contenttype">
                                    The request MUST contain `application/merge-patch+json` Content-Type header for JSON
                                    serialization of the merge patch document.
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-partialtd">
                                    The input MUST be in <a>Partial TD</a> form and conform to the
                                    original TD structure. 
                                </span>
                                
                                If the input contains members that appear in the original TD, 
                                their values are replaced. If a member do not appear in the 
                                original TD, that member is added. If the member is set to `null` 
                                but appear in the original TD, that member is removed. 
                                Members with object values are processed recursively.
                                
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-validation">
                                    After applying the modifications,
                                    the TD object SHOULD be validated syntactically using the 
                                    <a href="https://www.w3.org/TR/wot-thing-description/#json-schema-for-validation">Thing Description JSON Schema</a>
                                    [[WoT-Thing-Description]]. <!-- any way to add anchor to citations? -->
                                </span>
                                <span class="rfc2119-assertion" id="tdd-reg-update-partial-resp">
                                    Upon success, the server MUST respond with a 204 (No Content) status.
                                </span>
                                This operation is specified as `updatePartialTD` property in 
                                [[[#directory-thing-description]]].
                            </li>
                        </ul>

                        <p>
                            Error responses:
                            <ul>
                                <li>
                                    400 (Bad Request): Invalid serialization or TD.
                                    This is accompanied by an appropriate response message.
                                </li>
                                <li>
                                    404 (Not Found): TD with the given `id` not found (for `PATCH` only). 
                                </li>
                                <li>
                                    401 (Unauthorized): Rejecting a request without appropriate authentication.
                                </li>
                                <li>
                                    403 (Forbidden): Rejecting a request due to insufficient rights to the resource.
                                </li>
                            </ul>
                        </p>
                        </dd>
                    
                        <dt>TD Deletion</dt><dd>
                        <p>
                            <span class="rfc2119-assertion" id="tdd-reg-delete">
                                A TD MUST be removed from the directory when an HTTP `DELETE` request
                                is submitted to the location corresponding to the existing TD.
                            </span>
                            <span class="rfc2119-assertion" id="tdd-reg-delete-resp">
                                A successful response MUST have 204 (No Content) status.
                            </span>
                            The retrieve operation is specified as `deleteTD` property in
                            [[[#directory-thing-description]]].
                        </p>

                        <p>
                            Error responses:
                            <ul>
                                <li>
                                    404 (Not Found): TD with the given `id` not found.
                                </li>
                                <li>
                                    401 (Unauthorized): No authentication.
                                </li>
                                <li>
                                    403 (Forbidden): Insufficient rights to the resource.
                                </li>
                            </ul>
                        </p>
                        </dd>
                    </dl>

                </section>
                <section id="exploration-directory-api-management" class="normative">
                    <h4>Management</h4>
                    <p class="ednote" title="Management API">
                      To do: Other administrative functions not having to do with CRUD of individual records,
                    for example, security configuration.
                    Also, administrator roles may expand the capabilities of administrators for
                    management of records (for instance, the ability to delete a record they did not create).
                    </p>
                </section>
                <section id="exploration-directory-api-notification" class="normative">
                    <h4>Notification</h4>
                    <p>The Notification API is to notify clients about the changes
                        to Thing Descriptions maintained within the directory.
                        <span class="rfc2119-assertion" id="tdd-notification-sse">
                            The Notification API MUST follow the Server-Sent Events [[EVENTSOURCE]]
                            specifications to serve events to clients. 
                        </span>
                        In particular, the server responds to successful requests with 200 (OK) status
                        and `text/event-stream` Content Type. Re-connecting clients may continue from
                        the last event by providing the last event ID as `Last-Event-ID` header value.
                        This API is specified as `registration` event in [[[#directory-thing-description]]].
                    </p>

                    <dl>
                        <dt>Event Types</dt>
                        <dd>
                            <span class="rfc2119-assertion" id="tdd-notification-event-types">
                                The server MUST produce events for creation, update, and deletion of
                                Thing Descriptions represented by `created_td`, `updated_td`, `deleted_td`
                                keywords respectively.
                            </span>
                        </dd>

                        <dt>Event Filtering</dt>
                        <dd>
                            The API supports server-side filtering of events to reduce resource consumption
                            by delivering only the events required by clients.
                            The filtering is based on query parameters passed to the server at 
                            connection time. The filtering behavior is described below:
                            <ul>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-filter-type">
                                        The server MUST support event filtering based on the 
                                        event types passed as one or more `type` query parameters.
                                    </span>
                                    For example, in response to query `?type=created_td&type=deleted_td`,
                                    the server must only deliver events of types `created_td` and `deleted_td`.
                                    At the absence of any `type` query parameter, the server must deliver all
                                    types of events.
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-filter-tdid">
                                        The server MUST support event filtering based on the 
                                        Thing Description identifier passed as one or more `td_id` query parameters.
                                    </span>
                                    For example, the query `?type=updated_td&td_id=urn:example:1234` must
                                    result in `updated_td` events for the TD identified with `urn:example:1234`.
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-filter-search">
                                        The server MAY support event filtering based on the 
                                        search expressions passed as one of `jsonpath`, `xpath`, 
                                        or `sparql` query parameters.
                                    </span>
                                    <span class="rfc2119-assertion" id="tdd-notification-filter-search-unsupported">
                                        If the server does not support a given search query parameter, it
                                        MUST reject the request with 501 (Not Implemented) status.
                                    </span>
                                </li>
                            </ul>
                        </dd>
                        <dt>Event Data</dt>
                        <dd>
                            <span class="rfc2119-assertion" id="tdd-notification-data">
                                The event data MUST contain the JSON serialization of the event object.
                            </span>
                            The event data object is defined by the following rules:
                            <ul>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-tdid">
                                        The event data object MUST at least include the identifier of the
                                        TD created, updated, or deleted at that event as value of `td_id` field.
                                    </span>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-createdtd">
                                        When `include_changes` query parameter is set to `true`, the create
                                        event data object MAY include the created TD as the value of `created_td`
                                        field.
                                    </span>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-tdupdates">
                                        When `include_changes` query parameter is set to `true`, the update
                                        event data object MAY include the updated parts of the TD in
                                        <a>Partial TD</a> form as the value of `td_updates` field.
                                    </span>
                                </li>
                                <li>
                                    <span class="rfc2119-assertion" id="tdd-notification-data-change-unsupported">
                                        When a server which does not support the inclusion of changes inside event
                                        data object is requested with a `include_changes` query parameter, it MUST
                                        reject the request with 501 (Not Implemented) status.
                                    </span>
                                </li>
                            </ul>
                        </dd>
                    </dl>

                    <p class="ednote" title="SSE Authorization Header">
                        Some early SSE implementations (including HTML5 EventSource) do not allow
                        setting custom headers in the initial HTTP request. Authorization header 
                        is required in few OAuth2 flows and passing it as a query parameter is
                        <a href="https://tools.ietf.org/html/rfc6750#section-2.3">not advised</a>.

                        There are polyfills for browsers and modern libraries which allow 
                        setting Authorization header.
                    </p>
                    

                </section>
          <section id="exploration-directory-api-search" class="normative">
                    <h4>Search</h4>
                    
                    <p class="ednote" title="Search API Overview">
                    Sub-API to search a directory, e.g. issue a query.
                    There are different forms and levels of query possible, for example,
                    syntactic (JSONPath, XPath) vs. semantic (SPARQL), 
                    and the more advanced query types may not be 
                    supported by all directories.   
                    So this API will have further subsections,
                    some of which will be optional.
                    Search also includes a sub-API for managing listing the contents (eg returned by
                    a query) including handling pagination, etc.
                    Note that one special form of query will be able to return everything.
                    Results may be subject to the requestor's authorization.
                    <br>
                    To discuss further:
                    Federated queries to other TDDs, Spatial and network-limited queries, Links
                    </p>
        The Directory has three search APIs: syntactic search with JSONPath [[?JSONPATH]] or XPath [[xpath-31]], and semantic search with SPARQL [[sparql11-overview]].
		    <span class="rfc2119-assertion" id="tdd-search-apis-jsonPath">
			The Directory MUST implement the syntactic search with JSONPath.
		    </span>
		    <span class="rfc2119-assertion" id="tdd-search-apis-xPath">
			The Directory SHOULD implement the syntactic search with XPath.
		    </span>
		    <span class="rfc2119-assertion" id="tdd-search-apis-jsonPath">
			 The Directory MAY implement semantic search with SPARQL.
		    </span>
    		
        <section id="jsonpath-semantic" class="normative">
          <h4>Syntactic search: JSONPath</h4>
          <span class="rfc2119-assertion" id="tdd-search-jsonpath-method"> The API MUST allow searching TDs using an HTTP <code>GET</code> request.</span> 
          <span class="rfc2119-assertion" id="tdd-search-jsonpath-parameter"> The request MUST contain a valid JSONPath [[?JSONPATH]] as searching parameter.</span>
          <span class="rfc2119-assertion" id="tdd-search-jsonpath-response">  A successful response MUST have 200 (OK) status, contain <code>application/json</code> Content-Type header, and in the body a set of complete TDs or a set of TD fragments.</span>
          The syntactic search with JSONPath is specified as `searchJSONPath` property in
          [[[#directory-thing-description]]].

	  <p>List of errors:
            <ul>
              <li>400 (Bad Request): JSONPath expression not provided or contains syntax errors.</li>
              <li>401 (Unauthorized): No authentication.</li>
              <li>403 (Forbidden): Insufficient rights to the resource.</li>
            </ul>
          </p>
          <div class="issue" data-number="56">
              The standardization of JSONPath expressions is in progress by an independent working group.
          </div>
        </section>
	<section id="xpath-semantic" class="normative">
        <h4>Syntactic search: XPath</h4>
        The support for XPath Search API is recommended.
    	<span class="rfc2119-assertion" id="tdd-search-xpath-method">If implemented, the XPath query API MUST allow searching TDs using an HTTP <code>GET</code> request.</span>
    	<span class="rfc2119-assertion" id="tdd-search-xpath-parameter">The request MUST contain a valid XPath [[xpath-31]] as search parameter.</span>
    	<span class="rfc2119-assertion" id="tdd-search-xpath-response">A successful response MUST have 200 (OK) status, contain <code>application/json</code> Content-Type header, and in the body a set of complete TDs or a set of TD fragments.</span>
    The syntactic search with XPath is specified as `searchXPath` property in
    [[[#directory-thing-description]]].
                            
	 <p>List of errors:
    	  <ul>
    	   <li>400 (Bad Request): XPath expression not provided or contains syntax errors.</li>
           <li>401 (Unauthorized): No authentication.</li>
           <li>403 (Forbidden): Insufficient rights to the resource.</li>
           <li>501 (Not Implemented): XPath API not supported.</li>
    	  </ul>
    	 </p>
        </section>
	<section id="search-semantic" class="normative">
           <h4>Semantic search: SPARQL</h4>
           The support for SPARQL Search API is optional.
         <span class="rfc2119-assertion" id="tdd-search-semantic-protocol">If implemented, the SPARQL search API MUST allow searching TDs using the SPARQL protocol [[sparql11-overview]].</span>
         <span class="rfc2119-assertion" id="tdd-search-semantic-method-get">The SPARQL API MUST accept queries using HTTP <code>GET</code> requests.</span>
         <span class="rfc2119-assertion" id="tdd-search-semantic-method-post">The support for SPARQL search using HTTP <code>POST</code> method is OPTIONAL.</span>
         <code>UPDATE</code> queries are out of the scope for the API.
      	 <span class="rfc2119-assertion" id="tdd-search-semantic-parameter">A successful response MUST have 200 (OK) status, and depending on the type of query contain by default as Content-Type header <code>application/ld+json</code> for <code>CONSTRUCT</code> and <code>DESCRIBE</code> queries or <code>application/json</code> for <code>SELECT</code> or <code>ASK</code>. The response body MAY contain TD fragments or a set of TDs depending on the query.</span>
           The semantic search with SPARQL is specified as `searchSPARQL` property in
           [[[#directory-thing-description]]].
	 <p>List of errors:
              <ul>
                <li>400 (Bad Request): SPARQL query not provided or contains syntax errors.</li>
                <li>401 (Unauthorized): No authentication.</li>
                <li>403 (Forbidden): Insufficient rights to the resource.</li>
                <li>501 (Not Implemented): SPARQL API not supported.</li>
              </ul>
            </p>
	<span class="rfc2119-assertion" id="tdd-distributed-search-semantic">A WoT Thing Description Directory MAY implement federation in its SPARQL query API.</span>
	<span class="rfc2119-assertion" id="tdd-distributed-search-semantic-imp">If implemented, the SPARQL API MUST implement the SPARQL 1.1 Federated Query standard [[sparql11-overview]].</span>
	<p class="ednote" title="SPARQL DDoS attacks">
             The WoT Thing Directory should implement mechanisms to mitigate DDoS attacks in the SPARQL search API,
	     such as limiting the number or complexity of queries;
             this should be addressed in the Security Considerations section, where we should recommend some specific mitigations.
        </p>
	</section>
			
            </section>
            </section>
            <section id="exploration-directory-security" class="normative">
                <h3>Security and Privacy</h3>
                <p class="ednote" title="Security Considerations Overview">
                    Minimum security and privacy requirements for confidentiality, authentication, access control, etc.
                </p>
            </section>
        </section>
    </section>

    <section id="security-considerations" class="informative">
        <h1>Security and Privacy Considerations</h1>
        <p>
            Security and privacy are cross-cutting issues that need to be considered
            in all WoT building blocks and WoT implementations. This chapter
            summarizes some general issues and guidelines to help
            preserve the security and privacy of concrete WoT discovery implementations.
            For a more detailed and complete analysis of security and
            privacy issues, see the <em>WoT Security and Privacy Guidelines</em>
            specification [[?WOT-SECURITY]].
        </p>
        <p class="ednote" title="Discovery Security and Privacy Concerns and Mitigations">
        To do, some discussion of general security and privacy concerns and mitigations.
        Note that the architecture above is designed to address many such points, for
        example the two-phase approach and "authorization before metadata release"
        principles, so this would be 
        a summary and a recap.
        </p>
    </section>

    <section id="changes" class="appendix">
      <h1>Recent Specification Changes</h1>
<!--
      <h2 id="changes-from-first-draft">Changes from First Draft</h2>
-->
      <ul>
      <li>Initial draft.</li>
      </ul>
    </section>

    <section id="acknowledgements" class="appendix normative">
        <h1>Acknowledgments</h1>
<!--
        <p>Special thanks to X, Y, and Z
           for their contributions to this document.
        </p>
-->
        <p>
            Many thanks to the W3C staff and all other active Participants of the W3C Web
            of Things Interest Group (WoT IG) and Working Group (WoT WG) for their
            support, technical input and suggestions that led to improvements to
            this document.
        </p>
    </section>
</body>
</html>
